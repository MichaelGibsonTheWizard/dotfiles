/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 */
var goog=goog||{};goog.userAgent=goog.userAgent||{};goog.global=this;goog.string=goog.string||{};goog.string.contains=function(a,f){return a.indexOf(f)!==-1};goog.userAgent.ASSUME_IE=!1;goog.userAgent.ASSUME_GECKO=!1;goog.userAgent.ASSUME_WEBKIT=!1;goog.userAgent.ASSUME_MOBILE_WEBKIT=!1;goog.userAgent.ASSUME_OPERA=!1;goog.userAgent.ASSUME_EDGE=!1;
goog.userAgent.BROWSER_KNOWN_=goog.userAgent.ASSUME_EDGE||goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_GECKO||goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_OPERA;goog.userAgent.getUserAgentString=function(){return goog.global.navigator?goog.global.navigator.userAgent:null};goog.userAgent.getNavigator=function(){return goog.global.navigator};
goog.userAgent.init_=function(){goog.userAgent.detectedOpera_=!1;goog.userAgent.detectedEdge_=!1;goog.userAgent.detectedIe_=!1;goog.userAgent.detectedWebkit_=!1;goog.userAgent.detectedMobile_=!1;goog.userAgent.detectedGecko_=!1;var a;if(!goog.userAgent.BROWSER_KNOWN_&&(a=goog.userAgent.getUserAgentString())){var f=goog.userAgent.getNavigator();if(a.indexOf("Opera")===0)goog.userAgent.detectedOpera_=!0,goog.userAgent.ENGINE="Opera";if(!goog.userAgent.detectedOpera_&&a.indexOf("MSIE")!==-1)goog.userAgent.detectedIe_=
!0,goog.userAgent.ENGINE="IE";if(!goog.userAgent.detectedOpera_&&a.indexOf("WebKit")!==-1)goog.userAgent.detectedWebkit_=!0,goog.userAgent.ENGINE="WebKit";if(goog.userAgent.detectedWebkit_&&a.indexOf("Mobile")!==-1)goog.userAgent.detectedMobile_=!0;if(!goog.userAgent.detectedOpera_&&!goog.userAgent.detectedWebkit_&&f.product==="Gecko")goog.userAgent.detectedGecko_=!0,goog.userAgent.ENGINE="Gecko";if(a.indexOf("Edge")!==-1)goog.userAgent.detectedEdge_=!0}};goog.userAgent.BROWSER_KNOWN_||goog.userAgent.init_();
goog.userAgent.OPERA=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_OPERA:goog.userAgent.detectedOpera_;goog.userAgent.EDGE=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_EDGE:goog.userAgent.detectedEdge_;goog.userAgent.IE=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_IE:goog.userAgent.detectedIe_;goog.userAgent.EDGE_OR_IE=goog.userAgent.EDGE||goog.userAgent.IE;goog.userAgent.GECKO=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_GECKO:goog.userAgent.detectedGecko_;
goog.userAgent.WEBKIT=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_MOBILE_WEBKIT:goog.userAgent.detectedWebkit_;goog.userAgent.MOBILE=goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.detectedMobile_;goog.userAgent.SAFARI=goog.userAgent.WEBKIT;goog.userAgent.determinePlatform_=function(){var a=goog.userAgent.getNavigator();return a&&a.platform||""};goog.userAgent.PLATFORM=goog.userAgent.determinePlatform_();goog.userAgent.ASSUME_MAC=!1;
goog.userAgent.ASSUME_WINDOWS=!1;goog.userAgent.ASSUME_LINUX=!1;goog.userAgent.ASSUME_X11=!1;goog.userAgent.PLATFORM_KNOWN_=goog.userAgent.ASSUME_MAC||goog.userAgent.ASSUME_WINDOWS||goog.userAgent.ASSUME_LINUX||goog.userAgent.ASSUME_X11;
goog.userAgent.initPlatform_=function(){goog.userAgent.OS="";if(goog.string.contains(goog.userAgent.PLATFORM,"Mac"))goog.userAgent.detectedMac_=!0,goog.userAgent.OS="Mac";if(goog.string.contains(goog.userAgent.PLATFORM,"Win"))goog.userAgent.detectedWindows_=!0,goog.userAgent.OS="Windows";if(goog.string.contains(goog.userAgent.PLATFORM,"Linux"))goog.userAgent.detectedLinux_=!0,goog.userAgent.OS="Linux";if(goog.userAgent.getNavigator()&&goog.string.contains(goog.userAgent.getNavigator().appVersion||
"","X11"))goog.userAgent.detectedX11_=!0,goog.userAgent.OS="X11"};goog.userAgent.PLATFORM_KNOWN_||goog.userAgent.initPlatform_();goog.userAgent.MAC=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_MAC:goog.userAgent.detectedMac_;goog.userAgent.WINDOWS=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_WINDOWS:goog.userAgent.detectedWindows_;goog.userAgent.LINUX=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_LINUX:goog.userAgent.detectedLinux_;
goog.userAgent.X11=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_X11:goog.userAgent.detectedX11_;goog.userAgent.determineVersion_=function(){var a="",f=goog.userAgent.getVersionRegexResult_();f&&(a=f?f[1]:"");return goog.userAgent.IE&&(f=goog.userAgent.getDocumentMode_(),f!=null&&f>parseFloat(a))?String(f):a};
goog.userAgent.getVersionRegexResult_=function(){var a=goog.userAgent.getUserAgentString();if(goog.userAgent.GECKO)return/rv\:([^\);]+)(\)|;)/.exec(a);if(goog.userAgent.EDGE)return/Edge\/([\d\.]+)/.exec(a);if(goog.userAgent.IE)return/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(a);if(goog.userAgent.WEBKIT)return/WebKit\/(\S+)/.exec(a);if(goog.userAgent.OPERA)return/(?:Version)[ \/]?(\S+)/.exec(a)};goog.userAgent.getDocumentMode_=function(){var a=goog.global.document;return a?a.documentMode:void 0};
goog.userAgent.VERSION=goog.userAgent.determineVersion_();goog.userAgent.isDocumentModeCache_={};goog.userAgent.isDocumentMode=function(a){return goog.userAgent.isDocumentModeCache_[a]||(goog.userAgent.isDocumentModeCache_[a]=goog.userAgent.IE&&document.documentMode&&document.documentMode>=a)};goog.userAgent.product=goog.userAgent.product||{};goog.userAgent.product.ASSUME_FIREFOX=!1;goog.userAgent.product.ASSUME_CAMINO=!1;goog.userAgent.product.ASSUME_IPHONE=!1;
goog.userAgent.product.ASSUME_IPAD=!1;goog.userAgent.product.ASSUME_ANDROID=!1;goog.userAgent.product.ASSUME_CHROME=!1;goog.userAgent.product.ASSUME_SAFARI=!1;
goog.userAgent.product.PRODUCT_KNOWN_=goog.userAgent.ASSUME_EDGE||goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_OPERA||goog.userAgent.product.ASSUME_FIREFOX||goog.userAgent.product.ASSUME_CAMINO||goog.userAgent.product.ASSUME_IPHONE||goog.userAgent.product.ASSUME_IPAD||goog.userAgent.product.ASSUME_ANDROID||goog.userAgent.product.ASSUME_CHROME||goog.userAgent.product.ASSUME_SAFARI;
goog.userAgent.product.init_=function(){goog.userAgent.product.BROWSER_NAME="";goog.userAgent.product.detectedFirefox_=!1;goog.userAgent.product.detectedCamino_=!1;goog.userAgent.product.detectedIphone_=!1;goog.userAgent.product.detectedIpad_=!1;goog.userAgent.product.detectedAndroid_=!1;goog.userAgent.product.detectedChrome_=!1;goog.userAgent.product.detectedSafari_=!1;goog.userAgent.product.detectedIe_=!1;goog.userAgent.product.detectedEdge_=!1;var a=goog.userAgent.getUserAgentString();if(a)if(a.indexOf("iPhone")!==
-1||a.indexOf("iPod")!==-1)goog.userAgent.product.detectedIphone_=!0,goog.userAgent.product.BROWSER_NAME="iPhone";else if(a.indexOf("iPad")!==-1)goog.userAgent.product.detectedIpad_=!0,goog.userAgent.product.BROWSER_NAME="iPad";else if(a.indexOf("Android")!==-1)goog.userAgent.product.detectedAndroid_=!0,goog.userAgent.product.BROWSER_NAME="Android";else if(a.indexOf("Edge")!==-1)goog.userAgent.product.detectedEdge_=!0,goog.userAgent.product.BROWSER_NAME="Edge";else if(a.indexOf("Chrome")!==-1)goog.userAgent.product.detectedChrome_=
!0,goog.userAgent.product.BROWSER_NAME="Chrome";else if(a.indexOf("Safari")!==-1)goog.userAgent.product.detectedSafari_=!0,goog.userAgent.product.BROWSER_NAME="Safari";else if(a.indexOf("MSIE")!==-1)goog.userAgent.product.detectedIe_=!0,goog.userAgent.product.BROWSER_NAME="IE";else if(a.indexOf("Camino")!==-1)goog.userAgent.product.detectedCamino_=!0,goog.userAgent.product.BROWSER_NAME="Camino";else if(a.indexOf("Firefox")!==-1)goog.userAgent.product.detectedFirefox_=!0,goog.userAgent.product.BROWSER_NAME=
"Firefox"};goog.userAgent.product.PRODUCT_KNOWN_||goog.userAgent.product.init_();goog.userAgent.product.OPERA=goog.userAgent.OPERA;goog.userAgent.product.IE=goog.userAgent.IE;goog.userAgent.product.EDGE=goog.userAgent.EDGE;goog.userAgent.product.FIREFOX=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_FIREFOX:goog.userAgent.product.detectedFirefox_;goog.userAgent.product.CAMINO=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CAMINO:goog.userAgent.product.detectedCamino_;
goog.userAgent.product.IPHONE=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPHONE:goog.userAgent.product.detectedIphone_;goog.userAgent.product.IPAD=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPAD:goog.userAgent.product.detectedIpad_;goog.userAgent.product.ANDROID=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_ANDROID:goog.userAgent.product.detectedAndroid_;
goog.userAgent.product.CHROME=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CHROME:goog.userAgent.product.detectedChrome_;goog.userAgent.product.SAFARI=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_SAFARI:goog.userAgent.product.detectedSafari_;goog.userAgent.platform=goog.userAgent.platform||{};
goog.userAgent.platform.determineVersion_=function(){var a;if(goog.userAgent.WINDOWS)return a=/Windows NT ([0-9.]+)/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[1]:"0";else if(goog.userAgent.MAC)return a=/10[_.][0-9_.]+/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[0].replace(/_/g,"."):"10";return""};goog.userAgent.platform.VERSION=goog.userAgent.platform.determineVersion_();
goog.userAgent.product.determineVersion_=function(){var a="",f,b;if(goog.userAgent.product.FIREFOX)f=/Firefox\/([0-9.]+)/;else if(goog.userAgent.product.IE||goog.userAgent.product.OPERA)return goog.userAgent.VERSION;else goog.userAgent.product.EDGE?f=/Edge\/([0-9.]+)/:goog.userAgent.product.CHROME?f=/Chrome\/([0-9.]+)/:goog.userAgent.product.SAFARI?f=/Version\/([0-9.]+)/:goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD?(f=/Version\/(\S+).*Mobile\/(\S+)/,b=!0):goog.userAgent.product.ANDROID?
f=/Android\s+([0-9.]+)(?:.*Version\/([0-9.]+))?/:goog.userAgent.product.CAMINO&&(f=/Camino\/([0-9.]+)/);f&&(a=(a=f.exec(goog.userAgent.getUserAgentString()))?b?a[1]+"."+a[2]:a[2]||a[1]:"");return a};goog.userAgent.product.VERSION=goog.userAgent.product.determineVersion_();
var GoogleUserAgent=function(){return{browserName:goog.userAgent.product.BROWSER_NAME,osName:goog.userAgent.OS,engineName:goog.userAgent.ENGINE,browserVersionString:goog.userAgent.product.VERSION,engineVersionString:goog.userAgent.VERSION,isMobile:goog.userAgent.MOBILE}}();
function AppCacheEventProvider(a){function f(){m=!1;k=-1;p.done(function(){});KindleBuildInfo.getCurrentTotalAppcacheFileCount().then(p.resolve,p.reject)}function b(a,b,d){function c(){h.callEventListeners(a,b)}p.then(c,c);d&&(m=!0,p=jQuery.Deferred())}function d(a){m&&f();b("checking",a,!1)}function c(a){m&&f();k+=1;if(a.total!==void 0&&a.loaded!==void 0)p.resolve(a.total+1),h.callEventListeners("progress",a);else{var b=function(){a.loaded=k;return function(b){a.total=b===-1?-1:b-1;h.callEventListeners("progress",
a)}}();p.then(b,b)}}var h=ListenerManager(),k=-1,m=!0,p;p=jQuery.Deferred();(function(){typeof a.addEventListener==="function"&&(a.addEventListener("error",function(a){b("error",a,!0)}),a.addEventListener("cached",function(a){b("cached",a,!0)}),a.addEventListener("noupdate",function(a){b("noupdate",a,!0)}),a.addEventListener("updateready",function(a){b("updateready",a,!0)}),a.addEventListener("downloading",function(a){b("downloading",a,!1)}),a.addEventListener("checking",d,!1),a.addEventListener("progress",
c,!1))})();var q={status:0,abort:a.abort,update:a.update,swapCache:a.swapCache,addEventListener:h.addEventListener,removeEventListener:h.removeEventListener};$.extend(q,CreateAppCacheConstants());return q}function CreateAppCacheConstants(){var a={};["CHECKING","DOWNLOADING","IDLE","OBSOLETE","UNCACHED","UPDATEREADY"].forEach(function(f){a[f]=window.applicationCache[f]});return a}
var KindleAppCacheEventHandler=function(){function a(){r={timer:_metricsManager.createTimer(),loaded:0,total:0}}function f(){a()}function b(){KindleHostDeviceDetector.isNetworkAvailableSync()?(o.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserFailed",{breakdown:["Browser"]}):t.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RetryFailed",{breakdown:["Browser"]}):r.timer.emit("KindleApp:AppCacheError:FirstTime",{breakdown:["Browser"]}),r.timer.emit("KindleApp:AppCacheError",
{submetrics:[{name:"progress",value:r.total}],breakdown:["Browser"]}),KindleHostDeviceDetector.isiOS_4x()&&r.loaded===r.total&&t.getValue()>=1?(m(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART),o.increment(),_metricsManager.emit("KindleApp:AppCacheError:SafariRebootPrompt",{breakdown:["Browser"]})):(m(Kindle.APP_CACHE.CACHE_NEEDS_RETRY),t.increment(),_metricsManager.emit("KindleApp:AppCacheError:RetryPrompt",{breakdown:["Browser"]})),KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.isOnline()&&
g==="CHECKING"&&KindleLocalStorage.getItem("cached")&&(_metricsManager.emit("KindleApp:AppCacheError:OnlineInstafail",{breakdown:["Browser"]}),KindleLocalStorage.setItem("cached",0),KindleHostDeviceDetector.isiOSAppMode()&&(_metricsManager.emit("KindleApp::iOSAppModeAppCacheFix"),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register())),g=""):m(Kindle.APP_CACHE.CACHE_DONE)}function d(b){r===null&&a();m(Kindle.APP_CACHE.CACHE_PROGRESS,{progressRatio:b.total?b.loaded+1/b.total+
1:0});g="";r.loaded=b.loaded+1;r.total=b.total+1}function c(){o.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserSucess",{breakdown:["Browser"]}):t.getValue()>0&&_metricsManager.emit("KindleApp:AppCacheError:RetrySucess",{breakdown:["Browser"]});t.reset();o.reset()}function h(){g="";m(Kindle.APP_CACHE.CACHE_DONE);c();r.timer.emit("KindleApp:AppCacheUpdate",{submetrics:[{name:"progress",value:r.loaded}],breakdown:["Browser"]})}function k(){g="";m(Kindle.APP_CACHE.CACHE_CACHED);
KindleLocalStorage.getItem("cached")||KindleLocalStorage.setItem("cached",1);c();r&&r.loaded&&r.timer.emit("KindleApp:AppCacheSuccess",{submetrics:[{name:"progress",value:r.loaded}],breakdown:["Browser"]})}function m(a,b){b||(b={});w=a;q.callEventListeners(a,b)}var p,q=ListenerManager(),g="",r=null,t,o,w;return{initialize:function(a,c,m){_metricsManager=c;typeof Kindle==="undefined"&&(Kindle=m);t=LocalStorageCounter("AppCacheRetryCount");o=LocalStorageCounter("AppCacheBrowserRestartCount");p=a;g=
["UNCACHED","IDLE","CHECKING","DOWNLOADING","UPDATE READY","OBSOLETE"][p.status];try{p.addEventListener("checking",f,!1),p.addEventListener("error",b,!1),p.addEventListener("progress",d,!1),p.addEventListener("cached",k,!1),p.addEventListener("noupdate",k,!1),p.addEventListener("updateready",h,!1)}catch(q){}},getCacheStatus:function(){return w},removeEventListener:function(a,b){q.removeEventListener(a,b)},addEventListener:function(a,b,d){q.addEventListener(a,b,d)}}}(),KindleAppCacheManager=function(){function a(a){if(KindleHostDeviceDetector.isiOS_4x()||
KindleHostDeviceDetector.isFirefox())a=AppCacheEventProvider(a);try{KindleAppCacheEventHandler.initialize(a,h,k),b.resolve(KindleAppCacheEventHandler)}catch(d){b.reject()}}function f(f,p){h=f;k=p;b=$.Deferred();c?d||(d=$(document.createElement("iframe")).attr("seamless",!0).css("display","none").css("visibility","hidden").attr("src",KINDLE_APPCACHER_SRC)[0],$(document.body).append($(d)),KindleDebug.log("AppCacheIframe created")):a(window.applicationCache);return b.promise()}var b,d,c,h,k;return{initialize:function(a){var b=
[KindleModuleManager.METRICS_MANAGER,KindleModuleManager.CONSTANTS];(c=KindleHostDeviceDetector.isFirefox()&&window.applicationCache.status!==window.applicationCache.UNCACHED)&&b.push(a);KindleModuleManager.define(Kindle.MODULE.APPCACHE_EVENTHANDLER,b,f)},connectIframeAppCache:a}}();
Kindle.URL=function(){function a(){return window.location.host.split(".")[0].indexOf("read-")!==-1}function f(){return window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname}function b(a){for(var b={},a=a.split("&"),d=0;d<a.length;d++){var c;c=a[d].split("=");var k=c[0],g="";c.length>1&&(g=c[1]);c={key:k,value:g};c.key&&(b[c.key]=decodeURIComponent(c.value))}return b}function d(a){var b=a;a.indexOf("?")===0&&a.length>1&&(b=a.substring(1));return b}function c(a){var b=
"";a&&(b+="?"+a);return b}function h(a){var b={},d;for(d in a)g.indexOf(d)>-1&&(b[d]=a[d]);return b}function k(a){var b=p();b.hasOwnProperty(a)&&delete b[a];a=$.param(b);a=c(a);m(a)}function m(a){a=window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname+a+window.location.hash;if(window.history.replaceState)try{window.history.replaceState(document.title,document.title,a)}catch(b){}}function p(){var a={},c=window.location.search;c&&(a=d(c),a=b(a));return a=
h(a)}function q(){var a=p(),d=a[r];if(d){var d=decodeURIComponent(d),d=b(d),c;for(c in d)a[c]=d[c];delete a[r]}return a}var g=["srsBasePath","usePdxBucket","key","version","maxDBSize","ref_","siteState","kcrFree","autoHide","tag","language","lang","stringIDMode","region","host","hostVersion","clear","asin","library","ip","rwis"],r="siteState",t;return{normalizeQueryString:function(){var a=q(),a=$.param(a),a=c(a);m(a)},removeQueryParameter:k,removeAllQueryParameters:function(){var a=p(),b;for(b in a)a.hasOwnProperty(b)&&
k(b)},removeASIN:function(){k("asin")},addSavedStateToQueryParameters:function(){var a=q();if(t)for(var b in t)a[b]=t[b];a=$.param(a);a=c(a);m(a)},getQueryParameters:p,getFragIdParameters:function(){var a={};window.location.hash.length>0&&window.location.hash.substring(1).split("&").forEach(function(b){b=b.split("=");b.length===2&&(a[b[0]]=decodeURIComponent(b[1]))});return a=h(a)},getBaseURL:f,getHostURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port},
getBasePathURL:function(){return f().replace(/[^\/]*\.html$/,"")},getSiteState:function(){var a="",b=window.location.search,b=b||"",c;for(c in t)b&&(b+="&"),b+=c+"="+t[c];b&&(b=d(b),c=encodeURIComponent(b),a+=r+"="+c);return a},addToSavedSiteState:function(a){t||(t={});for(var b in a)t[b]=a[b]},getAmazonDomain:function(){var a=/^.*\.(amazon(\.[^.]*){1,2})$/.exec(window.location.host);return a!==null?a[1]:null},isJPDomain:function(){return Kindle.URL.isPreProd()?Kindle.URL.getPreProdCountryCode()===
"jp":Kindle.URL.getAmazonDomain()===Kindle.CountryToDomainMap.jp},isPreProd:a,getPreProdCountryCode:function(){if(a()){var b=window.location.host.split(".")[0],b=b.substr(b.length-3);if(b.charAt(0)==="-")return b.substr(1,2)}return""}}}();
function KindleAppFactory(){function a(){return!!F}function f(){return window.self!==window.top&&!F}function b(){aa||(aa=c(V.KINDLE_READER_ID,KINDLE_READER_SRC,"#"+V.KINDLE_READER_CONTAINER_ID))}function d(){ba||(ba=c(V.KINDLE_LIBRARY_ID,KINDLE_LIBRARY_SRC,"#"+V.KINDLE_LIBRARY_CONTAINER_ID))}function c(a,l,b){if(!KindleHostDeviceDetector.isMetro()&&l[0]==="."){var j=Kindle.top.location.href;j.slice(-1)!=="/"&&(j=j.slice(0,j.lastIndexOf("/")+1));l=j+l.slice(2)}a=$(document.createElement("iframe")).attr("id",
a).attr("seamless","seamless").addClass(qa);KindleHostDeviceDetector.isIE()||a.attr("src",l);$(b).append(a);KindleHostDeviceDetector.isIE()&&a[0].contentWindow.location.replace(l);return a}function h(a){if(a)a.readerClass?v.readerClass=a.readerClass:delete v.readerClass,a.readerAppBar?v.readerAppBar=a.readerAppBar:delete v.readerAppBar,a.cacheSample?v.cacheSample=a.cacheSample:delete v.cacheSample,a.returnToLibrary?v.returnToLibrary=a.returnToLibrary:delete v.returnToLibrary,a.position?(v.position=
Number(a.position),delete v.location):a.location?(v.location=Number(a.location),delete v.position):(delete v.position,delete v.location),v.asin=a.asin,a.isSample!==void 0?v.isSample=a.isSample?!0:!1:delete v.isSample,a.hostStorage===!0?v.contentProvider=o(v.asin):delete v.contentProvider;v.closeButton=f()?Kindle.Reader.CloseButtonNone:Kindle.Reader.CloseButtonAuto;v.standAlone=ba===void 0;v.asin&&G&&(G.openBook(v),KindleBanner.changeBookCover(v.asin),aa&&aa.focus(),v.standAlone&&$("#"+V.KINDLE_READER_CONTAINER_ID).removeClass("hidden"))}
function k(a){v.asin=void 0;KindleLocalStorage.setItem(Y,"");Kindle.URL.removeASIN();G&&(G.unloadReader(),G=null);$("#"+V.KINDLE_READER_CONTAINER_ID).addClass("hidden").empty();aa=void 0;a&&(ga=a);if(R)R.onReaderClose()}function m(){console.log("hiding library");ha=setTimeout(function(){$("#"+V.KINDLE_LIBRARY_CONTAINER_ID).addClass("hidden")},3E3)}function p(){console.log("hiding reader");G&&G.pauseReader();$("#"+V.KINDLE_READER_CONTAINER_ID).addClass("hidden");ha&&(clearTimeout(ha),ha=void 0);$("#"+
V.KINDLE_LIBRARY_CONTAINER_ID).removeClass("hidden");ba&&ba.focus();if(R!==null)R.onShowLibrary()}function q(){ga&&(KindleMetricsManager.endMetrics(ga),ga=null);b()}function g(){var a=KindleHostDeviceDetector.isInAppMode()?"inApp":"inBrowser",l=v.asin?"inReader":"inLibrary",b=KindleHostDeviceDetector.isOnline()?"online":"offline",a={submetrics:[{name:a,value:1},{name:l,value:1},{name:b,value:1}],breakdown:["Browser","Partner"]};KindleMetricsManager.emit("App::Open",a);f()&&KindleMetricsManager.emit("App::Open::Embedded",
a);v.kcrFree&&KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(a){a=a.getAuthenticationState();KindleMetricsManager.emit("App::Open::"+a)})}function r(){G&&G.unloadReader();KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).done(function(a){a.persistDB()})}function t(){var a,l=!0;!KindleHostDeviceDetector.isCookieEnabled()&&!v.kcrFree?(a=KINDLE_NO_COOKIE_SRC,l=!1):!KindleHostDeviceDetector.isLocalStorageEnabled()&&!v.kcrFree&&(a=KINDLE_NO_LOCAL_STORAGE_SRC,l=!1);l||
(a=$(document.createElement("iframe")).attr("src",a).addClass(qa).attr("seamless","seamless"),$("body").append(a));return l}function o(a){return RemoteContentCache.create({asin:a,contentProvider:F.contentProvider,contentRemover:F.deleteBookContent})}function w(){function a(b){KindleAppCacheEventHandler.addEventListener(b,function(){if(KindleHostDeviceDetector.isOnline())switch(b){case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:F.onAppCacheStatus("error");l=!1;break;case Kindle.APP_CACHE.CACHE_PROGRESS:l||
(F.onAppCacheStatus("incomplete"),l=!0);break;case Kindle.APP_CACHE.CACHE_DONE:case Kindle.APP_CACHE.CACHE_CACHED:F.onAppCacheStatus("success");if(window.applicationCache.status===window.applicationCache.UPDATEREADY)F.onAppCacheUpdateReady();l=!1}})}var l=!1;a(Kindle.APP_CACHE.CACHE_NEEDS_RETRY);a(Kindle.APP_CACHE.CACHE_PROGRESS);a(Kindle.APP_CACHE.CACHE_DONE);a(Kindle.APP_CACHE.CACHE_CACHED)}function s(){function a(l,b){function j(a){var b=e.elementFromPoint(a.pageX,a.pageY);return e.createTouch(l,
b,a.identifier,a.pageX,a.pageY,a.screenX,a.screenY)}function E(a){for(var l=[],b=0;b<a.length;b++)l.push(j(a[b]));return e.createTouchList.apply(e,l)}var e=l.document,n=e.createEvent("TouchEvent",{bubbles:!0});n.initTouchEvent(b.type,b.bubbles,b.cancelable,l,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,E(b.touches),E(b.targetTouches),E(b.changedTouches),b.scale,b.rotation);return n}function l(){return function(a){KindleTOS.proxyTouchEvent(a);a.preventDefault()}}
function b(l){return function(b){var e=l.querySelectorAll(".KindleIFrame");KindleAssert(e.length===1,"Expecting exactly one iFrame");var E=e[0],e=E.contentDocument,E=a(E.contentWindow,b);if(e=e.elementFromPoint(b.changedTouches[0].clientX,b.changedTouches[0].clientY))e.dispatchEvent(E),E.defaultPrevented&&b.preventDefault()}}document.addEventListener("touchmove",function(a){a.preventDefault()},!1);var j=["touchstart","touchmove","touchend","touchcancel"],e,E,n;if(KindleHostDeviceDetector.isiOS_8x()&&
KindleHostDeviceDetector.isInAppMode()){e=document.querySelectorAll(".touchproxy");for(E=0;E<e.length;E++)for(n=0;n<j.length;n++)e[E].addEventListener(j[n],b(e[E],0));e=document.querySelectorAll(".touchbhproxy");for(E=0;E<e.length;E++)for(n=0;n<j.length;n++)e[E].addEventListener(j[n],l(e[E]))}}function x(){KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseI18NSupported(X,v.language)?H("langSupport"):KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseVersionNonSupported(X)&&H();KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseCountryNotSupported(X,
v.language,v.ip).done(function(a){a&&H("countryBlk")})}function H(a){if(F){var l=Kindle.URL.getBasePathURL();l.indexOf("k4w")===-1&&(l=Kindle.URL.getHostURL()+"/");var b=KINDLE_UPGRADE_SRC.substr(1+KINDLE_UPGRADE_SRC.indexOf("/")),e=v.language||KindleHostDeviceDetector.getBrowserLanguage();l+=b+"?language="+e;l+=a?"&type="+a:"";F.showWebPage({url:l})}}function J(){var a,l,e;if(!F){e="library";if(v.hasOwnProperty("library"))KindleLocalStorage.removeItem(Y),Kindle.URL.removeQueryParameter("library");
else if(v.asin)e="book";else if(v.clear)Kindle.URL.removeQueryParameter("clear");else if(l=KindleLocalStorage.getItem(Y))try{a=JSON.parse(l);if(a.isSample!==void 0)v.isSample=a.isSample;if(a.type==="reader")e="book",v.asin=a.asin}catch(E){v.asin=l}e==="library"&&(d(),p())}b();g()}function y(a,l){var b=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(e){KindleHostDeviceDetector.isOnline()?e.getOwnedContent(a,l).then(b.resolve,b.reject):b.reject("offline")},
b.reject);return b.promise()}function D(){return{setLoginParameters:function(a){e(a)},setFocusToReader:function(){G&&G.setFocus()},showAppbar:function(){G&&G.setToolbarVisible(!0)},hideAppbar:function(){G&&G.setToolbarVisible(!1)},toggleAppbar:function(){G&&G.toggleToolbar()},openBook:function(a){v.asin&&(k(),b());h(a)},goTo:function(a){G&&(a.position>=0?G.goToPosition(a.position):a.location>=0&&G.goToLocation(a.location))},deregister:function(){return ca(!1,!0)},clearDatabases:function(){return KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).pipe(function(a){return a.clear()})},
clearLocalStorage:function(){KindleLocalStorage.clear();return $.Deferred().resolve({success:!0}).promise()},sendMetrics:function(a){a.metrics.method?KindleMetricsManager.emit(a.metrics.method,a.metrics):KindleMetricsManager.emit(a.metrics)},sendMetricsNow:function(a){a.metrics.method?KindleMetricsManager.emitNow(a.metrics.method,a.metrics):KindleMetricsManager.emitNow(a.metrics)},getOwnedContent:function(a){return y(a&&a.lastSyncTime||null,a&&a.reason||null)},requestDeviceName:function(){KindleDebug.warn("requestDeviceName not implemented yet (waiting for new service api)")},
requestDownloadedBookList:function(){return A()},getDownloadedBookInfo:function(a){return z(a)},downloadBook:function(a){C(a)},cancelBookDownload:function(){G&&G.cancelBookDownload()},removeBook:function(a){var l=$.Deferred();G?G.removeBook(a,l.resolve,l.reject):l.reject();return l.promise()},removeBookOwnership:function(a){return I(a)},getSearchContext:function(a){return G?G.getSearchContext(a):$.Deferred().reject()},requestOemAssociateId:function(a){var l=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(b){b.getOemAssociateId(a).then(l.resolve,
l.reject)},l.reject);return l.promise()},getTodoItems:function(a){var l=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(b){b.getTodoItems(a).then(l.resolve,l.reject)},l.reject);return l.promise()},removeTodoItems:function(a){var l=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(b){b.removeTodoItems(a).then(l.resolve,l.reject)},l.reject);return l.promise()},uploadSnapshot:function(a){var l=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(b){b.uploadSnapshot(a).then(l.resolve,l.reject)},l.reject);return l.promise()},getSearchIndex:function(a){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(l){return l.getSearchIndexInfo(a)})},getSelectedText:function(a){return G.getSelectedText(a)},hideContextMenu:function(){G.hideContextMenu()},setServiceHost:function(a){KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).done(function(l){l.setServiceHost(a)})},
uploadJournal:function(){return KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).pipe(function(a){return a.uploadJournal()})},setStoreCookies:function(a){var l=$.Deferred();try{for(var b=0;b<a.length;b++)document.cookie=a[b].value;setTimeout(l.resolve,0);return l.promise()}catch(e){return l.reject(e)}},updateAppCache:function(){window.applicationCache.update()},getTOSParams:function(a){var l=$.Deferred(),a=a||{};a.width=a.hasTouch?1366:2560;a.height=a.hasTouch?768:1440;a.dpi=a.hasTouch?
148:72;return l.resolve({cachePollAttemptInterval:18E5,cachePollWaitAfterSuccess:432E5,width:a.width,height:a.height,dpi:a.dpi}).promise()},moveAsinToHost:function(a){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(l){return l.moveBook(a)})},notifyMigrationStatus:function(a){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(l){return l.notifyMigrationStatus(a)})},convertPositions:function(a){if(G)return G.convertPositions(a)},
updateAnnotations:function(a){if(G)return G.updateAnnotations(a)},updateReaderChrome:function(a){if(G)return G.updateReaderChrome(a)},pingNA:function(){return KindleNetwork.pingNA()},getUrlForPfm:function(a){var l=new $.Deferred,b="";a&&a.method&&a.pfm&&Kindle.PFMLinks[a.pfm]&&(b=Kindle.PFMLinks[a.pfm][a.method]);return l.resolve({url:b})}}}function I(a){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(l){return l.removeOwnership(a.asin,a.contentType)})}function A(){var a=
jQuery.Deferred();KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(l){(l=l[KindleModuleManager.DB_CLIENT].getAppDb())&&l.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(a.resolve,a.reject)},a.reject);return a.promise()}function z(a){function l(e){var E,j,n={asin:a.asin};e.context=e.context||{};e.metadata=e.metadata||{};for(E in a)E!=="asin"&&a.hasOwnProperty(E)&&(j=e[E]||e.context[E]||e.metadata[E],j!==void 0&&(n[E]=j));b.resolve(n)}var b=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).then(function(e){e.getBookDb().BookInfoDB(a.asin).getBookInfo().then(l,b.reject)},b.reject);return b.promise()}function C(a){function l(){F.onBookDownloadComplete({asin:a.asin})}function b(l){F.onBookDownloadFailed({asin:a.asin,error:l})}function e(l){if(l!==a.prevPct)a.prevPct=l,F.onBookDownloadProgress({asin:a.asin,pct:l})}if(G){if(a.hostStorage===!0)a.contentProvider=o(a.asin);a.prevPct=0;G.downloadBook(a,e,l,b)}}function n(){h()}function u(a){var l=
a&&a.canOpen,b=a&&a.errorCode,a=a&&a.subErrorCode;KindleTOS.setOpenBookReady();ma();l?($("#"+V.KINDLE_READER_CONTAINER_ID).removeClass("hidden"),m()):j();if(R)R.onReaderOpenStatus(l,b,a)}function j(a){k(a);d();p()}function O(a){if(a){a={asin:v.asin,type:"reader"};if(v.isSample!==void 0)a.isSample=v.isSample;KindleLocalStorage.setItem(Y,JSON.stringify(a))}}function e(a){var l={hostApp:Q(),hostVersion:X,loginParams:a};KindleModuleManager.define(Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,[],function(){return l})}
function B(a){function l(){Kindle.URL.addSavedStateToQueryParameters();window.location.reload(!0)}switch(a.newState){case Kindle.Service.AuthOK:ia.resolve();break;case Kindle.Service.AuthError:a.prevState===Kindle.Service.AuthOK?ca(!0):ja();break;case Kindle.Service.AuthUserMismatch:KindleMetricsManager.emitNow("Service::ClientHashMismatch",{breakdown:["Browser"]});ra().always(l);break;case Kindle.Service.AuthTokenMismatch:l()}}function Q(){return F?{onServiceAuthState:F.onServiceAuthState,getRequestSigningHeaders:F.getRequestSigningHeaders}:
{onServiceAuthState:B,getRequestSigningHeaders:function(){KindleDebug.error("Non-Embedded applications do not use signed request headers.")}}}function N(){function a(b){var e={version:"1.0",clientName:v.kcrFree?Kindle.ClientName.KCRFree:KindleHostDeviceDetector.getClientName(),devicePlatform:l,marketplace:Kindle.DomainToCountryMap[Kindle.URL.getAmazonDomain()]},E={kindleStreamsUploadCallback:KindleModuleManager.getModuleSync(Kindle.MODULE.METRICS_UPLOADER).uploadKindleStreams,addMetrics:KindleMetricsManager.addKindleStreamsMetrics,
logger:KindleDebug,platformContext:e,isOnline:KindleHostDeviceDetector.isOnline};KindleStreamsManager.initialize(E);b={uploadCallback:KindleModuleManager.getModuleSync(Kindle.MODULE.METRICS_UPLOADER).uploadMetrics,kindleStreamsManager:KindleStreamsManager,platformContext:e,dbClient:b,logger:KindleDebug,isOnline:KindleHostDeviceDetector.isOnline,isNumber:isNumber,persistMetrics:!!b};KindleMetricsManager.initialize(b)}var l=KindleHostDeviceDetector.getDeviceType()+":"+KindleHostDeviceDetector.getDevicePlatform();
a();KindleMetricsManager.setBreakdown("Version",KindleVersion.getMetricsVersionString());da()&&KindleMetricsManager.setBreakdown("Partner",da());KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(l){a(l)})}function P(){KindleModuleManager.define(Kindle.MODULE.APPLICATION_ARGS,[],v);KindleDBClient.initialize();if(!F){var a={};a.srsBasePath=v.srsBasePath;a.usePdxBucket=v.usePdxBucket;e(a)}KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize());
a=KindleUserAgentMetricsInfo.browserWithVersionString();F&&KindleHostDeviceDetector.isMetro()&&(ContentMigration.initialize(),a=X);KindleMetricsManager.setBreakdown("Browser",a);KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(){Z=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);F&&Z.emit("zzz::HostVersion_"+X+"_kcr@"+KindleVersion.getMetricsVersionString())}).fail(function(){KindleDebug.error("metricsManagerInitializeError: Can not initialize metrics manager")})}
function M(a){var l;l={};if(da())l.tag=da();if(v.kcrFree)l.kcrFree=!0;if(a.refTag)l.refTag=a.refTag;if(l.asin=a.asin){KindleLocalStorage.removeItem(Y);if(!l.refTag)l.refTag=a.from===Kindle.SampleToDetailPageButton.Close?Kindle.RefTag.Values.StoreSampleClose:Kindle.RefTag.Values.StoreSample;Kindle.URL.isJPDomain()?(l="http://www.amazon.co.jp/dp/"+a.asin+"?ref="+l.refTag,W(l,a.openInNewTab)):LinkUrls.getDetailPage(l).then(function(l){W(l,a.openInNewTab||f())})}else Kindle.URL.isJPDomain()?(l=l.refTag?
"&ref_="+l.refTag:"",W("http://www.amazon.co.jp/b?node=2275256051"+l,a.openInNewTab)):(l.refTag=l.refTag||Kindle.RefTag.Values.StoreLibButton,LinkUrls.getStoreUrl(l).then(function(l){W(l,a.openInNewTab||f())}))}function K(){return!Kindle.URL.isJPDomain()}function L(a,l){var e=Z.startMetrics("Store::TOSOpen"),l=$.extend({storeStartTime:Date.now()},l),j=a===U.LIBRARY?R&&R.onStoreOpenStatus:G&&G.onStoreOpenStatus;ka||(ka=!0,KindleTOS.open(l).then(function(l){j&&j(Kindle.STORE.OPEN_STORE);l?KindleLocalStorage.removeItem(Y):
(a!==U.LIBRARY&&(k(),b()),m(),ma(),KindleTOS.setStoreClosedCallback(E));Z.endMetrics(e);ka=!1},function(){j&&j(Kindle.STORE.GENERIC_ERROR);Z.modifyMetricsMethod(e,"Store::TOSOpenFail");Z.endMetrics(e);ka=!1}))}function S(){var a=!!v.storePath,l=Kindle.PFMLinks[la]?Kindle.PFMLinks[la].country==="US":!1;return!f()&&Kindle.URL.getAmazonDomain()===Kindle.CountryToDomainMap.us&&l&&(KindleHostDeviceDetector.isiOS()||a)}function T(a,l){var b=a===U.LIBRARY?R&&R.onStoreOpenStatus:G&&G.onStoreOpenStatus;!KindleHostDeviceDetector.isOnline()&&
b?b(Kindle.STORE.OFFLINE_ERROR):S()?L(a,l):(l.openInNewTab=l.openInNewTab||KindleHostDeviceDetector.isiOS(),M(l),b&&b(Kindle.STORE.OPEN_STORE))}function ea(a,l){var b=l&&l.hasOwnProperty("asin")?l.asin:null,e=a===U.LIBRARY?Kindle.RefTag.Values.NotebookLibrary:Kindle.RefTag.Values.NotebookReader,E=a===U.LIBRARY?R&&R.onNotebookOpenStatus:G&&G.onNotebookOpenStatus;!KindleHostDeviceDetector.isOnline()&&E?E(Kindle.Notebook.OFFLINE_ERROR):(b=LinkUrls.getNotebookURL(b,e),W(b,!0),E&&E(Kindle.Notebook.OPEN_NOTEBOOK))}
function l(a){a=Kindle.URL.getBaseURL()+"?asin="+a.asin;W(a,f())}function E(){v.asin?(b(),va(1E3)):(d(),p(),R&&R.libraryUpdateNeeded())}function va(a){na=setTimeout(function(){fa&&($("body").append(fa),fa=null);var a=$("#loading_spinner"),l=$(window).width(),b=parseInt(a.css("width"),10),e=$(window).height(),E=parseInt(a.css("height"),10);a.css("top",(e-E)/2+"px").css("left",(l-b)/2+"px").show()},a)}function ma(){na&&clearTimeout(na);var a=$("#loading_spinner").detach();a.length&&!fa&&(fa=a)}function W(a,
l){if(F)KindleDebug.error("Tried to go to a different URL when we are hosted");else if(l&&KindleHostDeviceDetector.isiOS()&&window.navigator.standalone){var b=document.createElement("a");b.href=a;b.target="_blank";var e=document.createEvent("MouseEvents");e.initEvent("click",!0,!0);b.dispatchEvent(e)}else l?window.open(a):window.location=a}function ja(){return KindleRegistrationHandler.register()}function ca(a,l){return KindleRegistrationHandler.deregister(a,l).then(function(){if(F&&F.onDeregister)F.onDeregister(!0)},
function(){if(F&&F.onDeregister)F.onDeregister(!1)})}function ra(){KindleLocalStorage.clear();return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).clear()}function da(){return v.tag}function sa(){$(window).height()!==ta&&(ta=$(window).height(),$(window).trigger("resize"),window.scrollTo(0,0));setTimeout(sa,1E3)}var V={KINDLE_READER_ID:"KindleReaderIFrame",KINDLE_READER_CONTAINER_ID:"KindleReaderContainer",KINDLE_LIBRARY_ID:"KindleLibraryIFrame",KINDLE_LIBRARY_CONTAINER_ID:"KindleLibraryContainer",
KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},U={LIBRARY:"fromLibrary",READER:"fromReader"},oa,la="",qa="KindleIFrame",Y="last_app_activity",aa,ba,v={},G=null,R=null,ga,ka=!1,ha,na,fa,Z,pa,X,F,ia,ta=$(window).height,ua=!1;return{initialize:function(){if(!ua){ua=!0;KindleHostDeviceDetector.isiOSAppMode()||(Kindle.URL.normalizeQueryString(),v=$.extend({},Kindle.URL.getFragIdParameters(),Kindle.URL.getQueryParameters()));ma();oa=[Kindle.MODULE.APPCACHE_EVENTHANDLER,KindleModuleManager.RESOURCE_BUNDLE,
KindleModuleManager.DB_CLIENT,KindleModuleManager.METRICS_MANAGER,KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.CONSTANTS,KindleModuleManager.NETWORK,KindleModuleManager.JOURNAL_MANAGER,KindleModuleManager.LINK_URLS];KindleModuleManager.registerModule(KindleModuleManager.CONSTANTS,Kindle);KindleModuleManager.registerModule(KindleModuleManager.RESOURCE_BUNDLE,ResourceBundle);KindleModuleManager.registerModule(KindleModuleManager.NETWORK,KindleNetwork);KindleModuleManager.registerModule(KindleModuleManager.METRICS_MANAGER,
KindleMetricsManager);KindleModuleManager.registerModule(KindleModuleManager.LINK_URLS,LinkUrls);ResourceBundle.setStringIDMode(!!v.stringIDMode);ResourceBundle.initialize(v.language||v.lang,v.region);KindleTemplateManager.initialize();KindleStreamingReaderClient.initialize();N();s();document.title=ResourceBundle.getLocalizedString("k_window_title");ia=new jQuery.Deferred;KindleAppCacheManager.initialize(ia);KindleHostDeviceDetector.isiOS()&&$("body").addClass("ipad");if(KindleHostDeviceDetector.hasiOSInnerHeightBug())window.onresize=
function(){window.scrollTo(0,0)},$("body").addClass("iosInnerHeightBug");if(KindleHostDeviceDetector.isSafari(6.1))$(document).on("mousewheel",function(){});KindleDeviceCapabilities.hasPageResizeIssues()&&sa();if(t()){window.onbeforeunload=r;if(v.host){if(!KindleHostDeviceDetector.isMetro()||!/^(ms-appx:\/\/)?amznmobilellc.kindleforwindows8$/.test(v.host)){console.error("unknown embedded host: "+v.host);return}pa=v.host;X=v.hostVersion;F=ReaderHostInterfaceFactory(D(),pa);KindleModuleManager.define(KindleModuleManager.EMBEDDED_HOSTINTERFACE,
[],F);Kindle.URL.removeQueryParameter("host");x();F.onReaderLoaded({readerVersion:KindleVersion.getVersionString(),sendCrashWVMetricsVersions:[]});w();KindleHostDeviceDetector.isMetro()&&KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(a){a[KindleModuleManager.DB_CLIENT].enableFullDb().then(function(){KindleDebug.log("In metro mode, enabling full database")},function(){KindleDebug.error("In metro mode, was not able to enable full database.")})})}if(v.ref_)if(Kindle.RefTag.isRWISRefTag(v.ref_)){var a=
v.ref_,l=v.asin?v.asin:"";Kindle.URL.addToSavedSiteState(v);Kindle.URL.removeAllQueryParameters();KindleBanner.showRWISBanner(a,l)}else Kindle.URL.addToSavedSiteState({ref_:v.ref_}),Kindle.URL.removeQueryParameter("ref_");v.tag&&(Kindle.URL.addToSavedSiteState({tag:v.tag}),Kindle.URL.removeQueryParameter("tag"));if(v.kcrFree&&!v.asin)v.asin=Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED;P();v.storePath&&KindleTOS.setStoreURL(decodeURIComponent(v.storePath));KindleTOS.setOpenBookCallback(h);KindleTOS.setStoreClosedCallback(E);
if(v.kcrFree)J();else{var b;KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){b=a;return a.authenticate()}).pipe(function(){b.getPFM().done(function(a){la=a.pfm;var l=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).getKindleStreamsManager();l.setPfm(la);l.setEid(a.eid);LinkUrls.initializeEid(a.eid)});J()})}(F||v.kcrFree)&&ia.resolve();KindleChromeInstaller.initialize()}}},registerEventCallback:function(a,l){var b=[],e;for(e in Kindle.APP_CACHE)b.push(Kindle.APP_CACHE[e]);
b.indexOf(a)>=0&&KindleAppCacheEventHandler.addEventListener(a,l)},getSharedModuleSync:function(a){oa.indexOf(a)===-1&&KindleDebug.error(a+"is not a shared module");return KindleModuleManager.getModuleSync(a)},getSharedModules:function(){return KindleModuleManager.getModuleList(oa)},getAppInterfaceForReader:function(){function e(a){setTimeout(function(){k(a);b()},0)}return F?{onReaderReady:n,closeReader:function(a){F.onBookClose();e(a)},onStartReadingStatus:function(a){F.onBookOpenStatus(a);(!a||
!a.canOpen)&&e()},onRendererLoaded:O,openStore:function(a){F.onOpenStore({origin:U.READER,asin:a})},openNotebook:function(a){F.onOpenNotebook({origin:U.READER,asin:a})},pinBookToStart:function(a){F.pinBookToStart(a)},onReaderTapped:function(){F.onReaderTapped()},onUserAction:function(){F.onUserAction()},hideAppBar:function(){F.hideAppBar()},onBookDownloadComplete:function(a){F.onBookDownloadComplete(a)},searchContent:function(a){F.searchContent(a)},showAnnotations:function(a){F.showAnnotations(a)},
isHostControlled:a,isEmbeddedInWebsite:f,isNotebookAvailable:K}:{onReaderReady:n,closeReader:j,onStartReadingStatus:u,onRendererLoaded:O,openStore:function(a){T(U.READER,a)},openNotebook:function(a){ea(U.READER,a)},openFullKCR:l,register:ja,deregister:ca,pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},onBookDownloadComplete:function(){},searchContent:function(){},showAnnotations:function(){},isHostControlled:a,isEmbeddedInWebsite:f,isNotebookAvailable:K}},
setReaderInterface:function(a){KindleInterfaces.assertImplements(a,KindleInterfaces.IKindleReader);G=a},getAppInterfaceForLibrary:function(){return{openExternalLink:function(a){W(a,!0)},storeIsTOS:S,openStore:function(a){T(U.LIBRARY,a)},isNotebookAvailable:K,openNotebook:function(a){ea(U.LIBRARY,a)},openBook:h,onLibraryLoaded:q,getQueryParameters:function(){return v},register:ja,deregister:ca}},setLibraryInterface:function(a){KindleInterfaces.assertImplements(a,KindleInterfaces.IKindleLibrary);R=
a},cleanupForNextUser:ra,register:ja,deregister:ca,getQueryParams:function(){return v},gotoURL:W,isHostControlled:a,isEmbeddedInWebsite:f,isNotebookAvailable:K,getEmbeddorHostname:function(){return pa},getPartnerTag:da}}var KindleApp=KindleAppFactory();typeof amznJQ!=="undefined"&&amznJQ.declareAvailable("cascade");
var KindleBanner=function(){function a(){if(h){var a=window.innerHeight||document.body.clientHeight||document.documentElement.clientHeight;a-=$("#"+d.KINDLE_BANNER_CONTAINER_ID).height();a={height:a};$("."+d.KINDLE_APP_CONTAINER).css(a)}}function f(){if(!h){h=!0;$("."+d.KINDLE_BANNER_CONTAINER_ID).css("display","block");var b={top:$("#"+d.KINDLE_BANNER_CONTAINER_ID).height()+"px"};$("."+d.KINDLE_APP_CONTAINER).css(b);a();window.addEventListener("resize",a)}}function b(a){return"https://images-na.ssl-images-amazon.com/images/P/"+
a+".01._SX60_SY80_TTXW_SCLZZZZZZZ_.jpg"}var d={KINDLE_APP_CONTAINER:"KindleAppContainer",KINDLE_BANNER_CONTAINER_ID:"KindleBannerContainer",KINDLE_BANNER_CENTER:"kindleApp_banner_center",KINDLE_BANNER_TEXT:"kindleApp_banner_RWIS_text"},c,h=!1,k={rwis:4,next_available:5},m={rwis:1};return{showRWISBanner:function(p,q){function g(){c.emit("Banner::RWIS::LearnMore")}function r(){c.emit("Banner::RWIS::GetAppLink")}if(!k.rwis||!m.rwis?0:LocalStorageCounter("kcrNotification."+k.rwis).getValue()<m.rwis){c||
(c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));c.emit("Banner::RWIS::Show");var t=KindleHostDeviceDetector.isiOS(),o=p&&p==="kcr_rwis_kshare"?!0:!1,o={learnMoreLink:LinkUrls.getKCPLandingPageLink(p),bookCoverURL:b(q),isiPad:t,isKp:o},o=$(Handlebars.templates.KindleRWISBanner(o)),w=ResourceBundle.getLanguage();if(t)switch(o.find("#kindleApp_banner_get_app_button").click(r),w){case "de":case "fr":o.find("#"+d.KINDLE_BANNER_CENTER).css("width","540px");o.find("#"+d.KINDLE_BANNER_TEXT).css({"line-height":"20px",
"padding-top":"0"});break;case "ja":case "it":o.find("#"+d.KINDLE_BANNER_TEXT).css("padding-top","0");o.find("#"+d.KINDLE_BANNER_CENTER).css("width","465px");break;case "pt":o.find("#"+d.KINDLE_BANNER_TEXT).css("padding-top","0");o.find("#"+d.KINDLE_BANNER_CENTER).css("width","505px");break;case "es":o.find("#"+d.KINDLE_BANNER_TEXT).css("padding-top","0"),o.find("#"+d.KINDLE_BANNER_CENTER).css("width","525px")}else t={showAppleLogo:!0,showWindowsLogo:!Kindle.URL.isJPDomain(),showAmazonLogo:!0,showAndroidLogo:!0},
t=new KindleTextMeWidget(t,"KindleRWISBanner"),o.find("#kindleApp_banner_text_me_widget_wrapper").append(t),o.find("#kindleApp_banner_learn_more").click(g),w==="fr"&&o.find("#"+d.KINDLE_BANNER_TEXT).css("line-height","20px");o.find("#kindleApp_banner_close_button").click(function(){h&&(window.removeEventListener("resize",a),$("."+d.KINDLE_BANNER_CONTAINER_ID).css("display","none"),$("."+d.KINDLE_APP_CONTAINER).css({top:"0px",height:"100%"}),h=!1);k.rwis&&m.rwis&&LocalStorageCounter("kcrNotification."+
k.rwis).increment();c.emit("Banner::RWIS::Close")});$("#KindleBannerContainer").append(o);f()}},changeBookCover:function(a){h&&(a=b(a),$("#kindleApp_banner_book_cover").attr("src",a))}}}(),KindleBuildInfo=function(){function a(a,d,c){var h=$.Deferred();$.getJSON(f,Math.floor(Math.random()*1E9),function(k){k=k[a];c(k)?h.resolve(k):h.reject(d)}).error(function(){h.reject(d)});return h.promise()}var f="./offline/build_info.uncached.js";return{getCurrentTotalAppcacheFileCount:function(){return a("filecount",
-1,function(a){return typeof a==="number"&&a>1})}}}(),KindleMetricsManager=function(){function a(){function a(){Date.now()-j>b&&(P=Date.now());j=Date.now();setTimeout(a,e)}if(!M){M=!0;var b=2E4,e=5E3,j;P=0;Date.now();j=Date.now();setTimeout(a,e)}}function f(a){if(a.timerStart>=P)return!0;a=Date.now()-a.timerStart;H("Metrics::Suspended",{time:a});return!1}function b(){if(I.length>0){var a=I;I=[];g().insertList(a).fail(function(){Array.prototype.push.apply(a,I);I=a})}}function d(){B&&Q<=Date.now()+
N||(clearTimeout(B),B=setTimeout(function(){B=null;d();q()},N),Q=Date.now()+N)}function c(a){if($.isArray(a))return a;var b;if(a){b=[];for(var e in a)b.push(a[e])}return b}function h(a){var b=a.timers;if(b)for(var e in b);a.timers=c(a.timers);a.counters=c(a.counters)}function k(a){for(var b=new jQuery.Deferred,e=0;e<a.length;e++)h(a[e]);a.length>0&&g()?g().insertList(a).then(function(){b.resolve(a)},function(){p(a).then(function(){b.resolve(a)},function(){Array.prototype.push.apply(I,a);b.reject(a)})}):
(Array.prototype.push.apply(I,a),b.resolve(a));return b.promise()}function m(a,b,e){var j=z[a],a=j.counters;if(!a)a=j.counters={};j=a[b];if(!j&&(j=a[b]={},j.name=b,j.count=0,e))typeof e==="string"&&(e=[e]),j.breakDown=e;return j}function p(a){var b=new jQuery.Deferred,e=/exception/i;if(n()){for(var d=[],c=[],l=0;l<a.length;l++){var E=a[l];E.kindleStream?c.push(E.kindleStream):d.push(E)}D.uploadMetrics(c);C(j.devicePlatform,j.clientName,j.version,j.marketplace,j.breakdownDeclarations,d).then(function(a){a.Output.metricProcessCount&&
a.Output.metricProcessCount>0||a.Output.__type&&a.Output.__type.match(e)?b.resolve(d):b.reject(d)},function(){b.reject(d)})}else b.reject(d);return b.promise()}function q(){var a,b=new jQuery.Deferred;if(n()){if(!g())return b.reject(),b.promise();g().batchTransaction([{operation:Kindle.DB.GET_RECORD_OPERATION,tableName:J,params:[]},{operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:J,params:[]}]).done(function(e){if(e[0]&&e[0].length>0){a=e[0];for(e=0;e<a.length;e++){var j=a[e];if(j.breakDown)j.breakdown=
j.breakDown,delete j.breakDown}p(a).done(b.resolve).fail(function(){g()&&g().insertList(a);b.reject()})}}).fail(function(){b.reject()})}else b.reject();return b.promise()}function g(){try{if(y)return y.getAppDb().getTable(J)}catch(a){}return null}function r(a){function b(a,l){var e={};e.name=l.name;e.count=l.value;var j=t(l.breakdown);if(j.length>0)e.breakDown=j;if(!a.counters)a.counters=[];a.counters.push(e)}if(!(typeof a==="object"&&typeof a.name==="string"&&typeof a.params==="undefined"||typeof a.params===
"object"))return null;var e={},j=a.name,a=$.extend({},a.params);e.method=j;e.time=0;if(a){if(a.time>=0&&u(a.time))e.time=a.time;if(a.submetrics){if(!$.isArray(a.submetrics))a.submetrics=[a.submetrics];for(j=0;j<a.submetrics.length;j++)b(e,a.submetrics[j])}j=t(a.breakdown);if(j.length>0)e.breakDown=j}return e}function t(a){var b=[];if(a===void 0)return b;$.isArray(a)||(a=[a]);for(var e=0;e<a.length;e++)typeof a[e]==="string"&&(O.indexOf(a[e]),b.push(a[e]));return b}function o(a){a||(a={});if(!a.startTime)a.startTime=
Date.now();u(a.startTime);this.params=a}function w(a,b){return a=$.map(a,function(a){a.time=b;return a})}function s(a){if(typeof a[0]==="string"){var b={};b.name=a[0];if(a[1])b.params=a[1];a=[b]}else a=$.isArray(a[0])?a[0]:[];return $.map(a,r)}function x(){}function H(){var a=s(arguments);return k(a).fail(x)}var J="metrics",y=null,D=null,I=[],A=0,z={},C,n=function(){return navigator.onLine},u=isNumber,j={breakdownDeclarations:{}},O=["Browser","Version","Partner","ProcessorClass","ViewState","SystemLanguage",
"Online","CloudItemsCount","LocalItemsCount","HostVersion","PFM","CrashLocation"],e=Object.freeze({Short:3E4,Default:3E5,Min:1E4,Max:6E5}),B=null,Q=0,N=e.Default,P,M=!1;o.prototype.elapsed=function(){var a=0;u(this._elapsed)?a=this._elapsed:u(this.params.startTime)&&f({timerStart:this.params.startTime})&&(a=Date.now()-this.params.startTime);return a};o.prototype.stop=function(){this._elapsed=Date.now()-this.params.startTime;return this};o.prototype.emit=function(){var a=this.elapsed(),b=s(arguments),
b=w(b,a);return k(b).fail(x)};o.prototype.emitNow=function(){var a=this.elapsed(),b=s(arguments),b=w(b,a);return p(b).fail(x)};return{modifyMetricsMethod:function(a,b){if(z[a])z[a].method=b},startMetrics:function(a,b){var e={};e.method=a;e.timerStart=Date.now();if(b&&b.breakdown)e.breakDown=t(b.breakdown);A++;z[A]=e;return A},endMetrics:function(a,b){var e,j=z[a];if(j&&j.timerStart){if(f(j))j.time=Date.now()-j.timerStart;delete j.timerStart;var n=[j];b&&(typeof b==="string"&&(b=[b]),$.each(b,function(a,
b){var e=$.extend({},j);e.method+=b;n.push(e)}));e=k(n);delete z[a]}else e=(new jQuery.Deferred).reject().promise();return e},cancelMetrics:function(a){delete z[a]},startSubTimer:function(a,b,e){var j=z[a],a=j.timers;if(!a)a=j.timers={};j=a[b];if(!j&&(j=a[b]={},j.name=b,j.count=0,j.time=0,e=t(e),e.length>0))j.breakDown=e;if(!j.timerStart)j.timerStart=Date.now()},endSubTimer:function(a,b){var e=z[a].timers[b];e.timerStart!==void 0&&(f(e)&&(e.count+=1,e.time+=Date.now()-e.timerStart),delete e.timerStart)},
renameSubTimer:function(a,b,e){var a=z[a],j=a.timers[b];if(j.time>=0)a.timers[e]=j,a.timers[e].name=e,delete a.timers[b]},getSubTimer:function(a,b){return z[a].timers[b]},setSubCounter:function(a,b,e,j){a=m(a,b,j);u(e)||(e=1);a.count=e},increaseSubCounter:function(a,b,e,j){a=m(a,b,j);u(e)||(e=1);a.count+=e},initialize:function(e){D=e.kindleStreamsManager;C=e.uploadCallback;j=$.extend(j,e.platformContext);y=e.dbClient;n=e.isOnline||n;u=e.isNumber;e.persistMetrics&&(b(),d());a()},uploadMetrics:q,setMetricsUploadInterval:function(a){var b=
N;e.Min<a&&a<e.Max||(a=N);a!==N&&(N=a,d());return b},UploadInterval:e,getKindleStreamsManager:function(){return D},addKindleStreamsMetrics:k,setBreakdown:function(a,b){$.isArray(b)&&(b=b.join(":"));typeof b==="string"&&O.indexOf(a)>-1&&(j.breakdownDeclarations[a]=b)},clearBreakdowns:function(){j.breakdownDeclarations={}},replaceBreakdowns:function(a){j.breakdownDeclarations=a},createTimer:function(){return new o},emitNow:function(){var a=s(arguments);return p(a).fail(x)},emit:H}}(),KindleStreamsManager=
function(){function a(a,k){function f(a,b){var d=s.getLastSpan();(a!=d.startPosition||b!=d.endPosition)&&q(a,b)}function p(a,b){var k=s.getBookMetadata();c.openContent(k.contentType,k.embeddedId,k.asin,k.srl,k.erl,k.bookLength,{},k.bookOpenTime);d();s.setStatus(o);q(a,b)}function q(b,g){s.setLastSpan({startPosition:b,endPosition:g});a===k?c.consumeContentPoint("Reading","Text",a,{},Date.now()):c.consumeContentSpan("Reading","Text",a,k,{},Date.now());d()}g.log("Consume Content was called. Current state: ["+
b()+"]");var m=s.getStatus();m===t?p(a,k):m===o&&f(a,k)}function f(){g.log("Hide was called. Current state: ["+b()+"]");s.getStatus()===o&&(c.hideContext("Book",{},Date.now()),d(),s.setStatus(w))}function b(){var a=s.getStatus();return a?a.name:"null"}function d(){var a=c.events.pop();p([{method:"KindleStreamsData",time:-1,kindleStream:a}])}var c=null,h=null,k=null,m=null,p=null,q={},g=null,r={name:"CLOSED",value:0},t={name:"OPEN_BUT_UNCONSUMED",value:1},o={name:"OPEN",value:2},w={name:"HIDDEN",value:3},
s=function(){function a(d){g.log("KS: Setting status to ["+d.name+"]");b=d}var b=r,d=null,c=null;return{getStatus:function(){return b},setStatus:a,getLastSpan:function(){return c},setLastSpan:function(a){c=a},getBookMetadata:function(){return d},setBookMetadata:function(a){d=a},reset:function(){c=d=null;a(r)}}}();return{initialize:function(a){typeof a.kindleStreamsUploadCallback!=="function"&&reportError("Invalid uploadCallback","The initialization parameter 'uploadCallback' must be a function");
h=a.kindleStreamsUploadCallback;p=a.addMetrics;g=a.logger;q=$.extend(q,a.platformContext);c=new Manager;s.reset()},setPfm:function(a){k=a},setEid:function(a){m=a},uploadMetrics:function(a){var b=new jQuery.Deferred;if(a&&a.length>0){var d=Manager.buildUploadKindleStreamsRequest(a,q.devicePlatform,q.clientName,q.marketplace,k,m,KindleVersion.getVersionNumber());h(d.url,d.postData).then(b.resolve(a),b.reject(a))}else b.resolve([]);return b.promise()},openBook:function(a){g.log("OpenBook was called. Current state: ["+
b()+"]");if(s.getStatus()===r){s.reset();var d={bookOpenTime:Date.now()};$.extend(d,a);s.setBookMetadata(a);s.setStatus(t)}},closeBook:function(){g.log("Close Book was called. Current state: ["+b()+"]");f();s.reset()},consumeContent:a,showBook:function(){g.log("Restore was called. Current state: ["+b()+"]");if(s.getStatus()===w){var d=s.getBookMetadata();d.bookOpenTime=Date.now();s.setBookMetadata(d);s.setStatus(t);d=s.getLastSpan();a(d.startPosition,d.endPosition)}},hideBook:f}}(),EventTypes=function(){function a(){}
a.OpenContext="OpenContext";a.ShowContext="ShowContext";a.HideContext="HideContext";a.OpenContent="OpenContent";a.Action="Action";a.ContentAction="ContentAction";a.ConsumeContentSpan="ConsumeContentSpan";a.ConsumeContentPoint="ConsumeContentPoint";a.AuxContentState="AuxContentState";a.Metadata="Metadata";a.SettingState="SettingState";return a}(),Manager=function(){function a(){this.events=[]}a.prototype.getEvents=function(){return this.events.slice(0)};a.prototype.clearEvents=function(a){var b=this.events;
b.splice(0,a&&a<b.length?a:b.length)};a.prototype.addEvent=function(a){this.events.push(a)};a.prototype.consumeContentPoint=function(a,b,d,c,h){c===void 0&&(c={});this.addEvent({type:EventTypes.ConsumeContentPoint,timestamp:h||Date.now(),context:a||KSRequestHandler.CONTEXT_FALLBACK,pointType:b,position:Math.max(d||0,0),metadataMap:c})};a.prototype.consumeContentSpan=function(a,b,d,c,h,k){h===void 0&&(h={});this.addEvent({type:EventTypes.ConsumeContentSpan,context:a||KSRequestHandler.CONTEXT_FALLBACK,
timestamp:k||Date.now(),spanType:b,startPosition:d,endPosition:c,metadataMap:h})};a.prototype.hideContext=function(a,b,d){b===void 0&&(b={});this.addEvent({type:EventTypes.HideContext,context:a||KSRequestHandler.CONTEXT_FALLBACK,timestamp:d||Date.now(),metadataMap:b})};a.prototype.openContent=function(a,b,d,c,h,k,m,p){m===void 0&&(m={});this.addEvent({type:EventTypes.OpenContent,contentType:a,timestamp:p||Date.now(),asin:d,embeddedId:b,srl:c,erl:h,bookLength:k,metadataMap:m})};a.prototype.openContext=
function(a,b,d,c){d===void 0&&(d={});this.addEvent({type:EventTypes.OpenContext,openerContext:a||KSRequestHandler.CONTEXT_FALLBACK,openedContext:b||KSRequestHandler.CONTEXT_FALLBACK,timestamp:c||Date.now(),metadataMap:d})};a.prototype.performAction=function(a,b,d,c){d===void 0&&(d={});this.addEvent({type:EventTypes.Action,context:a||KSRequestHandler.CONTEXT_FALLBACK,actionId:b,timestamp:c||Date.now(),metadataMap:d})};a.prototype.performContentAction=function(a,b,d,c,h,k){h===void 0&&(h={});this.addEvent({type:EventTypes.ContentAction,
context:a||KSRequestHandler.CONTEXT_FALLBACK,actionId:b,startPosition:d,endPosition:c,timestamp:k||Date.now(),metadataMap:h})};a.prototype.recordAuxContentState=function(a,b,d,c,h,k,m){k===void 0&&(k={});this.addEvent({type:EventTypes.AuxContentState,auxContentType:a,supportsMainContent:b,hasData:d,isEnabled:c,supportsNoData:h,timestamp:m||Date.now(),metadataMap:k})};a.prototype.recordMetadata=function(a,b,d){this.addEvent({type:EventTypes.Metadata,context:a||KSRequestHandler.CONTEXT_FALLBACK,timestamp:d||
Date.now(),metadataMap:b})};a.prototype.recordSetting=function(a,b,d,c,h,k){h===void 0&&(h={});this.addEvent({type:EventTypes.SettingState,context:a||KSRequestHandler.CONTEXT_FALLBACK,settingId:b,state:d,isChange:c,timestamp:k||Date.now(),metadataMap:h})};a.prototype.showContext=function(a,b,d){b===void 0&&(b={});this.addEvent({type:EventTypes.ShowContext,context:a||KSRequestHandler.CONTEXT_FALLBACK,timestamp:d||Date.now(),metadataMap:b})};a.getUploadUrl=function(){for(var a=!1,b=0,d=[/k4w/,/pre/];b<
d.length;b++)if(d[b].test(window.location.hostname)){a=!0;break}b="read.amazon.co.jp";a&&(b="read-pre-prod-jp.amazon.com");return"https://"+b+"/api/uploadMetrics"+window.location.search};a.buildUploadKindleStreamsRequest=function(f,b,d,c,h,k,m){f={devicePlatform:b,clientName:d,versionForKindleStreams:m,messageNumber:-1,sessionId:"-1",breakdowns:{},metrics:[],kindleStreamsMetrics:f.map(function(a){return JSON.stringify(a)}),marketplace:c,pfm:h,eid:k,isSync:!0};return{url:a.getUploadUrl(c),serviceCall:"uploadMetrics",
postData:f,async:!f.isSync}};return a}(),KSRequestHandler=function(){function a(){}a.CONTEXT_FALLBACK="Unknown";return a}(),KindleNetwork=function(){function a(){return p=navigator.onLine}function f(){a()===!1?b(!1):$.ajax("/service/web/reader/ping")}function b(a){k&&(window.clearTimeout(k),k=0);m=Date.now();a!==h&&(h=a,c.callEventListeners(a?"online":"offline"));d()}function d(){c.hasEventListener(h?"offline":"online")?k||(k=window.setTimeout(f,h?9E5:18E4)):k&&(window.clearTimeout(k),k=0)}var c=
new ListenerManager,h=!0,k,m=0,p;return{pingNA:function(){var a=new $.Deferred;$.ajax("https://read.amazon.com").then(function(b,d,c){a.resolve(c&&c.status!==0)},function(){a.resolve(!1)});return a.promise()},initialize:function(){$(document).ajaxComplete(function(a,d,c){c.qaMetricsIngester||b(!!d.status)});document.body.addEventListener("offline",f);document.body.addEventListener("online",f);b(a())},addEventListener:function(a,b){c.addEventListener(a,b);d()},removeEventListener:function(a,b){c.removeEventListener(a,
b);d()},isOnline:function(d){p!==a()&&b(p);d=Number(d);return Date.now()-m<(d>=0?d:Infinity)?h:p===!1?!1:null}}}();
Kindle.RefTag=function(){return{Values:{StorePromoMangaJP:"kcr_store_promo_manga_jp",StoreLibButton:"kcr_store_libbutton",StoreSample:"kcr_store_sample",StoreSampleClose:"kcr_store_sample_close",StoreEmptyLibIpad:"kcr_store_emptylib_ipad",StoreLibButtonIpad:"kcr_store_libbutton_ipad",NotebookLibrary:"kcr_notebook_lib",NotebookReader:"kcr_notebook_rdr"},isRWISRefTag:function(a){return a&&a.indexOf("kcr_rwis_")===0}}}();
var KindleRegistrationHandler=function(){function a(){var a=f(Kindle.URL.getBaseURL()),c=b.apUrl;c+="?openid.assoc_handle="+b.assocHandle;c+="&openid.return_to="+encodeURIComponent(a);c+="&openid.mode=logout";c+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";(a=Kindle.URL.getSiteState())&&(c+="&"+a);KindleApp.gotoURL(c)}function f(a){var c=b.apUrl;c+="?openid.assoc_handle="+b.assocHandle;c+="&openid.return_to="+encodeURIComponent(a);c+="&openid.mode=checkid_setup";c+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";
c+="&openid.identity=";c+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";c+="&openid.claimed_id=";c+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";c+="&pageId=amzn_kcr";(a=Kindle.URL.getSiteState())&&(c+="&"+a);return c}var b=function(){function a(b){b=b.toLowerCase();return{apUrl:"https://"+b+"-pre-prod.amazon.com/ap/signin",assocHandle:"amzn_kweb_"+b}}var b=Kindle.URL.getAmazonDomain();if(Kindle.URL.isPreProd()){var f=Kindle.URL.getPreProdCountryCode();if(f)return a(f)}return function(){var a=
Kindle.DomainToCountryMap[b];return{apUrl:"https://www."+b+"/ap/signin",assocHandle:a==="us"?"amzn_kweb":"amzn_kweb_"+a}}()}();return{register:function(){KindleApp.gotoURL(f(Kindle.URL.getBaseURL()))},deregister:function(b,c){function f(){var a=new jQuery.Deferred;KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).then(function(b){b.uploadJournal().then(a.resolve,a.resolve)});return a.promise()}function k(){var a=new jQuery.Deferred;w.getAppDb().getPinnedSessionIds().done(function(b){KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).deregisterSessions(b).then(a.resolve,
a.reject)});return a.promise()}function m(){function a(){r.uploadMetrics().then(q,q)}t.then(a,a)}function p(){g.reject()}function q(){c?KindleApp.cleanupForNextUser().then(function(){KindleDebug.log("db & localStorage cleared.");KindleApp.isHostControlled()||a();g.resolve()},function(){KindleDebug.log("Failed to clear db/localStorage");KindleApp.isHostControlled()||a();g.resolve()},function(a){g.notify(a)}):(KindleLocalStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG),w.getAppDb().clearDeviceToken().then(a,
a),g.resolve())}var g=new jQuery.Deferred,r=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),t,o=r.createTimer();t=c?o.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Intentional"}]):o.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Unintentional"}]);var w=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);b?q():$.when(f(),k()).then(m,p);return g.promise()}}}(),KindleStreamingReaderClient=function(){function a(a){var b,a=a||{};b=(a.srsHostName||
"")+("/"+(a.srsBasePath||"service")+"/")+"web/";D=b+"content/";a.useSignedServiceRequests&&(b+="device/");y=b+"reader/";I=b+"register/";A=y+"setOfflineStatus/";z=y+"deregisterSessions/";C=y}function f(){n=!0}function b(a){var b={prevState:N,newState:a};if(a===Kindle.Service.AuthOK&&(b.eid=e,B))b.deviceName=B;N=a;Q.onServiceAuthState(b)}function d(a,e,d){function n(){b(Kindle.Service.AuthError);c.reject(a,e,d)}if(a.status===J){var c=$.Deferred();j=null;M.clearDeviceToken().then(n,n);return c.promise()}else return $.Deferred().reject(a,
e,d)}function c(a,b){return $.ajax({url:a,dataType:"json",beforeSend:function(a){a.setRequestHeader("x-amzn-sessionid",b);return!0}}).pipe(null,d)}function h(){var a=$.cookie("session-id"),b=function(){var a=I+"getDeviceToken",b=KindleHostDeviceDetector.getDeviceType();a+="?serialNumber="+(K||b)+"&deviceType="+b;return encodeURI(a)}(),e=P.createTimer();return c(b,a).pipe(function(a,b,l){b=jQuery.Deferred();a.deviceSessionToken?b.resolve(a):(b.reject(l,"failed"),e.emit("Service::GetDeviceTokenCallBrokenResult"));
e.emit("Service::GetDeviceTokenCall");return b.promise()}).fail(function(){e.emitNow("Service::GetDeviceTokenCallFail")})}function k(a,b){return{url:a,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify(b)}}function m(a){function e(){KindleDebug.error("Failed to sign SRS request.");return $.Deferred().reject()}function n(a){var b;b=/\/web.*$/.exec(a.url);return!b?e():Q.getRequestSigningHeaders({path:b[0],verb:a.type||"GET",data:a.data||""}).pipe(function(b){a.beforeSend=
function(a){$.each(b,function(b,l){a.setRequestHeader(b,l)});return!0};return $.Deferred().resolve(a)},e)}function c(a){return j?(a.beforeSend=function(a){a.setRequestHeader("X-ADP-Session-Token",j);return!0},$.Deferred().resolve(a)):(KindleDebug.error("Device Token must be loaded in order to make an authenticated request. Cancelling request."),b(Kindle.Service.AuthError),$.Deferred().reject())}o();return(L?n(a):c(a)).pipe($.ajax).pipe(null,d)}function p(a){a.beforeSend=function(a){a.setRequestHeader("Amzn-Device-Type",
KindleHostDeviceDetector.getDeviceType());return!0};return $.ajax(a)}function q(a){function b(){m(d).done(j.resolve).fail(function(a){KindleHostDeviceDetector.isiOSAppMode()&&a.status===0&&u.emit("KindleApp::iOSAppModeStatusCodeIsZero")}).fail(function(a,l,e){a.status!==J&&(l!=="timeout"&&n-- >0?(setTimeout(b,c),c*=2):j.reject(a,l,e))})}var e=a.url,j=$.Deferred(),d={url:e,dataType:"json"},n=1,c=50;b();var u=P.createTimer();j.done(function(){u.emit(a.metricId)});j.fail(function(){u.emitNow(a.metricId+
"Fail")});return j.promise()}function g(a){function b(){p(d).done(j.resolve).fail(function(a,l,e){a.status!==J&&l!=="timeout"&&n-- >0?(setTimeout(b,c),c*=2):j.reject(a,l,e)})}var e=a.url,j=$.Deferred(),d={url:e,dataType:"json"},n=1,c=50;b();var u=P.createTimer();j.done(function(){u.emit(a.metricId)});j.fail(function(){u.emitNow(a.metricId+"Fail")});return j.promise()}function r(){function a(l,e,d){function n(){(!l||l.status!==J)&&b(Kindle.Service.AuthError);k.reject(l,e,d)}j=null;M.clearDeviceToken().then(n,
n)}function d(){N!==Kindle.Service.AuthOK&&b(Kindle.Service.AuthOK);k.resolve(j)}function n(c){if(O&&O!==c.clientHashId)b(Kindle.Service.AuthUserMismatch);else{j=c.deviceSessionToken;O=c.clientHashId;e=c.eid;if(c.deviceName)B=c.deviceName;jQuery.when(M.setDeviceToken(c.deviceSessionToken),M.setUserHashId(c.clientHashId),M.setEID(c.eid)).then(d,a)}}function c(){h().then(n,a)}function u(a){O=a[Kindle.Service.UserHashIdKey];e=a[Kindle.Service.EidKey];a[Kindle.Service.DeviceTokenKey]?(j=a[Kindle.Service.DeviceTokenKey],
d()):c()}var k=$.Deferred();j?k.resolve(j):M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(u,c);return k.promise()}function t(){var a=$.Deferred();M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(function(b){O=b[Kindle.Service.UserHashIdKey];e=b[Kindle.Service.EidKey];b[Kindle.Service.DeviceTokenKey]?(j=b[Kindle.Service.DeviceTokenKey],a.resolve(!0)):a.resolve(!1)},function(){a.resolve(!1)});
return a.promise()}function o(){function a(){b(Kindle.Service.AuthTokenMismatch);e.reject()}var e=$.Deferred();if(!j)return e.resolve();var d=P.createTimer();M.getDeviceToken().done(function(b){b!==j?d.emit("Service::CheckTokenConsistencyMismatch",{breakdown:["Browser"]}).always(a):e.resolve()}).fail(function(){n||d.emit("Service::CheckTokenConsistencyFail",{breakdown:["Browser"]}).always(a)});return e.promise()}function w(a){return a&&(a==="only"||N!==Kindle.Service.AuthOK)}function s(a,b){var e=
y+a+"?asin="+b.asin+"&kindleSessionId="+b.kindleSessionId;return b.position&&b.position>0?(e+="&lastPageRead="+b.position+"&localTimeOffset="+b.localTimeOffset+"&countryCode="+b.countryCode,e+="&positionType="+b.positionType,e=encodeURI(e)+(!b.refEmId?"":"&guid="+encodeURIComponent(b.refEmId))):encodeURI(e)}function x(a,b){var e=k(a,b);e.crossDomain=!0;return p(e)}function H(a,b,e,j,d,n){function c(a,b,l,e,d,n){return{Operation:n?"uploadMetricsExternal":"uploadMetrics",Input:{devicePlatform:a,clientName:b,
version:l,marketplace:j,metricBreakdown:e,metrics:d}}}var u;return function(){function j(a,b,l){var e=$.Deferred();return l.responseText.indexOf("UploadMetricsResponse")===-1?e.reject():e.resolve(a,b,l)}var B=Kindle.Service.AuthOK===N&&(L||$.cookie("at-main")),g=y+"uploadMetrics";return B?(u=c(a,b,e,d,n,!1),m(k(g,u)).pipe(j)):$.Deferred().reject()}().pipe(null,function(){var j=D+"uploadMetrics";u=c(a,b,e,d,n,!0);return p(k(j,u))}).done(function(){var a;if(a=S||KindleLocalStorage.getItem("QAMetricsURL"))a=
{url:a,type:"POST",dataType:"json",processData:!1,headers:{Source:window.location.href},contentType:"application/json",data:JSON.stringify(u),qaMetricsIngester:!0},$.ajax(a).fail(function(a){a.status&&KindleDebug.warn("Failed to echo metrics to the QA ingester service; statusCode="+a.statusCode)})})}var J=403,y,D,I,A,z,C,n=!1,u,j,O,e,B,Q,N,P,M,K,L,S,T;a();$.ajaxSetup({headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},timeout:6E4});var ea={getAuthenticationState:function(){return N},authenticate:function(){if(N===
Kindle.Service.AuthOK)return $.Deferred().resolve();else if(L)return $.Deferred().reject();return r()},checkTokenConsistency:o,deregisterSessions:function(a){return q({metricId:"Service::DeregisterSessionsCall",url:function(a){a=z+"?sessions="+a.join();return encodeURI(a)}(a)})},doneReading:function(a){return q({metricId:"Service::DoneReadingCall",url:s("doneReading",a)})},getAnnotations:function(a,b){var e=y+"getAnnotations?asin="+encodeURIComponent(a)+(!b?"":"&guid="+encodeURIComponent(b));return q({metricId:"Service::GetAnnotationsCall",
url:e})},getEID:function(){function a(){return $.Deferred().resolve(e)}function b(){var j=P.createTimer();return h().fail(function(){j.emitNow("Service::GetEIDTokenCallFail")}).pipe(function(b){e=b.eid;j.emit("Service::GetEIDTokenCallSuccess");return M.setEID(b.eid).pipe(a,a)},null)}return e?a():M.getEID().pipe(null,b)},getFileUrl:function(a){var b=w(a.kcrFree),e={metricId:"Service::GetFileUrlCall",url:function(){var e=b?D:y;e+="getFileUrl?asin="+a.asin+"&contentVersion="+a.contentVersion+"&formatVersion="+
a.formatVersion;KindleHostDeviceDetector.hasCanvasSizeLimitProblem()||(e+="&clientVersion="+u);e+=T?"&usePdxBucket="+T:"";e+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";e+=a.isSample?"&isSample="+a.isSample:"";e+=a.skeletonIds?"&skeletonIds="+a.skeletonIds.join(","):"";e+=a.fragmentIds?"&fragmentIds="+a.fragmentIds.join(","):"";e+=a.glyphIds?"&glyphIds="+a.glyphIds.join(","):"";e+=a.resourceIds?"&resourceIds="+a.resourceIds.join(","):"";e+=a.locationMapIds?"&locationMapIds="+a.locationMapIds.join(","):
"";return encodeURI(e)}()};return(b?g:q)(e)},getLPR:function(a,b){var e=y+"getLPR?asin="+encodeURIComponent(a)+(!b?"":"&guid="+encodeURIComponent(b));return q({metricId:"Service::GetLPRCall",url:e})},getOemAssociateId:function(a){var a={Operation:"getAssociateId",Input:{deviceType:a.deviceType,deviceParameters:{eid:a.eid,oemPartnerName:a.oemPartnerName,oemDealGuid:a.oemDealGuid}}},b=y+"getAssociateId",e=P.createTimer();return m(k(b,a)).then(function(a){e.emit("Service::OemAssociateIdSuccess");(!a||
!a.Output||!a.Output.associateId)&&e.emit("Service::OemAssociateIdEmpty")},function(){e.emit("Service::OemAssociateIdFailure")})},getOwnedContent:function(a,b){return q({metricId:"Service::GetOwnedContentCall",url:function(){var e="";a&&(e="?lastSyncTime="+encodeURIComponent(a));b&&(e?e+="&":e="?",e+="reason="+encodeURIComponent(b));return y+"getOwnedContent"+e}()})},getPFM:function(){return q({metricId:"Service::GetPFMCall",url:y+"getPFM"})},getTodoItems:function(a){var b=a.reason,e=a.versionNumber,
a=C+"getTodoListItems?maxNumItems="+(a.maxNumItems||a.count);b&&(a+="&reason="+b);e&&(a+="&softwareRev="+e);a=encodeURI(a);return q({metricId:"Service::GetTodoItemCall",url:a})},getSearchIndexInfo:function(a){var b=w(a.kcrFree),e=b?D:y;e+="getSearchIndex?asin="+encodeURIComponent(a.asin)+"&formatVersion="+encodeURIComponent(a.formatVersion)+"&contentVersion="+encodeURIComponent(a.contentVersion);return(b?g:q)({url:e,metricId:"Service::GetSearchIndex"})},getWordDefinition:function(a){var b=Kindle.Service.AuthOK===
N,a={metricId:"Service::GetWordDefinitionCall",url:encodeURI((b?y:D)+"getWordDefinition?word="+a)};return(b?q:g)(a)},removeTodoItems:function(a){if(a.length!==1)return $.Deferred().reject("Must be one item").promise();var a=a[0],b=C+"removeTodoListItem";b+="?type="+a.type+"&action="+a.action+"&key="+a.key+"&completeStatus="+(a.completeStatus||a.complete_status)+"&failureCode="+(a.failureCode||a.failure_code||"");b=encodeURI(b);return q({metricId:"Service::RemoveTodoItemsCall",url:b})},resetLPR:function(a){return q({metricId:"Service::ResetLPRCall",
url:s("resetLPR",a)})},removeOwnership:function(a,b){return q({metricId:"Service::RemoveOwnershipCall",url:y+"removeOwnership?asin="+a+"&contentType="+b})},setOfflineStatus:function(a){return q({metricId:"Service::SetOfflineStatusCall",url:encodeURI(A+"?asin="+a.asin+"&kindleSessionId="+a.kindleSessionId+"&offline="+(a.isOffline?"true":"false"))})},setServiceHost:function(b){a({useSignedServiceRequests:L,srsHostName:b})},startReading:function(a){var b=w(a.kcrFree),e={metricId:"Service::StartReadingServiceCall",
url:function(){var e=b?D:y;e+="startReading?asin="+a.asin;e+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";e+=a.contentVersion?"&contentVersion="+a.contentVersion:"";e+=a.formatVersion?"&formatVersion="+a.formatVersion:"";e+=a.isSample!==void 0?"&isSample="+(a.isSample?"true":"false"):"";u&&(e+="&clientVersion="+u);return encodeURI(e)}()};return(b?g:q)(e)},stillReading:function(a){return q({metricId:"Service::StillReadingCall",url:s("stillReading",a)})},updateAnnotations:function(a,b){var e=
y+"updateAnnotations",j={Operation:"updateAnnotations",Input:{annotations:a,localTimeOffset:b}},d=P.createTimer();return m(k(e,j)).then(function(){d.emit("Service::UpdateAnnotationsCall")},function(){d.emitNow("Service::UpdateAnnotationsCallFail")})},uploadMetrics:H,uploadSnapshot:function(a){a=C+"uploadSnapshot?snapshot="+encodeURIComponent(a.response);return q({metricId:"Service::UploadSnapshotCall",url:a})},whenOnline:function(){var a=jQuery.Deferred();if(KindleNetwork.isOnline())a.resolve();else{var b=
function(){KindleNetwork.removeEventListener("online",b);a.resolve()};KindleNetwork.addEventListener("online",b)}return a.promise()}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.SERVICE_CLIENT,[Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,KindleModuleManager.METRICS_MANAGER,Kindle.MODULE.DB_CLIENT],function(e,j,d){var n=jQuery.Deferred();P=j;M=d.getAppDb();var c,k;Q=e.hostApp;if(e.loginParams)K=e.loginParams.dsn,L=!!e.loginParams.useSignedServiceRequests,S=e.loginParams.qaMetricsUrl,
c=e.loginParams.hostName,k=e.loginParams.srsBasePath,T=e.loginParams.usePdxBucket;u=KindleApp.isHostControlled()?KindleVersion.parseVersionString(e.hostVersion):KindleVersion.getVersionNumber();KindleNetwork.initialize();window.addEventListener("beforeunload",f,!1);L?M.getUserHashId().always(function(j){j&&e.loginParams.clientHashId&&j!==e.loginParams.clientHashId?b(Kindle.Service.AuthUserMismatch):b(Kindle.Service.AuthOK);a({useSignedServiceRequests:!0,srsHostName:c,srsBasePath:k});n.resolve(ea)}):
(k&&a({srsBasePath:k}),t().then(function(a){b(a?Kindle.Service.AuthOK:Kindle.Service.NotAuth);n.resolve(ea)},n.reject));return n});KindleModuleManager.define(Kindle.MODULE.METRICS_UPLOADER,[],function(){return{uploadMetrics:H,uploadKindleStreams:x}})}}}(),KindleTOS=function(){function a(){var a="https://images-na.ssl-images-amazon.com/images/G/01/kindle/kindlefortheweb/store/"+I+"/BrowserHost-min.js",b=$.Deferred();if(f())return b.resolve().promise();$.getScript(a,function(){f()?b.resolve():b.reject()});
return b.promise()}function f(){return typeof BrowserHostAPI!=="undefined"}function b(){var a=new jQuery.Deferred,b={w:$(window).width(),h:$(window).height(),dpi:null,osv:null,deviceType:KindleHostDeviceDetector.getDeviceType(),bhv:I};KindleModuleManager.getModule([KindleModuleManager.SERVICE_CLIENT]).then(function(e){e.getEID().then(function(e){b.eid=e;a.resolve("?"+$.param(b))},function(){KindleDebug.error("Couldn't fetch EID.");a.reject("?"+$.param(b))})},function(){KindleDebug.error("SRS not loaded");
a.reject("?"+$.param(b))});return a.promise()}function d(a){function d(b){var n=H?"&asin="+encodeURIComponent(H):"",b=D+b+n+("&ref_="+(a||(H?Kindle.RefTag.Values.StoreSample:y?Kindle.RefTag.Values.StoreEmptyLibIpad:Kindle.RefTag.Values.StoreLibButtonIpad))),n=KindleApp.getPartnerTag();b+=n?"&tag="+n:"";r&&$("#"+t.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();n=new Date;r=$(document.createElement("iframe")).attr("id",t.KINDLE_STORE_ID+n.getTime()).attr("src",b).attr("seamless","seamless").addClass(o);
$("#"+t.KINDLE_STORE_CONTAINER_ID).append(r)}b().then(d,d)}function c(){$("#"+t.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();C=r=null;n=!0;z&&z()}function h(){var b=$.Deferred();a().then(function(){var a={hostVersion:w,storeStartTime:J,deviceType:KindleHostDeviceDetector.getDeviceType()};BrowserHost=new K4WBrowserHost(a,{pageReady:k,closeStore:m,openBook:p,bookStatus:q,openInExternalBrowser:g});b.resolve()},b.reject);return b.promise()}function k(){clearTimeout(s);$("#"+t.KINDLE_STORE_CONTAINER_ID).removeClass("hidden");
x.resolve(!1)}function m(){c()}function p(a){if(n){n=!1;var b=a.type,a=a.asin;if(A)switch(b){case u.EBOOK:A({asin:a,isSample:!1});c();break;case u.SAMPLE:A({asin:a,isSample:!0}),C=a,$("#"+t.KINDLE_STORE_CONTAINER_ID).hide(),z&&z()}}}function q(a){return{id:a,status:1,percentDownloaded:1}}function g(a){clearTimeout(s);x.resolve(!0);var b=document.createElement("a");b.href=a;b.target="_blank";a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0);b.dispatchEvent(a)}var r,t={KINDLE_STORE_ID:"store",
KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},o="KindleIFrame",w=3,s,x,H,J,y,D="https://www.amazon.com/gp/kindle/kcp/tos.html",I="029",A,z,C,n=!0,u={EBOOK:"EBOK",SAMPLE:"EBSP"};return{open:function(a){x=$.Deferred();H=a.asin;J=a.storeStartTime;y=a.isSourceEmptyLibBtn;if(H&&H===C&&r)return $("#"+t.KINDLE_STORE_CONTAINER_ID).show(),x.resolve(!1),x.promise();h().then(function(){s=setTimeout(function(){x.reject();c()},3E4);d(a.refTag)},x.reject);return x.promise()},setOpenBookCallback:function(a){A=
a},setStoreClosedCallback:function(a){z=a},setOpenBookReady:function(){n=!0},setStoreURL:function(a){D=a},proxyTouchEvent:function(a){if(f()){var b=JSON.parse(JSON.stringify(a));b.type=a.type;b.bubbles=a.bubbles;BrowserHost.proxyTouchEvent(b)}}}}(),KindleUpgradeDeviceDetector=function(){function a(a,b,d){a=KindleVersion.parseVersionString(a);return KindleVersion.parseVersionString(b)<=a&&a<=KindleVersion.parseVersionString(d)}return{isMetroUpdateRequiredBecauseVersionNonSupported:function(f){if(!KindleHostDeviceDetector.isMetro())return!1;
var b=!!KindleHostDeviceDetector.isOnline();return f&&b?a(f,"0.0.0.0","1.1.3.1"):!1},isMetroUpdateRequiredBecauseI18NSupported:function(f,b){if(!KindleHostDeviceDetector.isMetro())return!1;var d=!!KindleHostDeviceDetector.isOnline();return["de","es","it","fr","pt"].indexOf((b||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2))>-1&&f&&d?a(f,"1.0.2.0","1.0.2.99"):!1},isMetroUpdateRequiredBecauseCountryNotSupported:function(f,b,d){var c=jQuery.Deferred(),h=!!KindleHostDeviceDetector.isOnline(),
b=(b||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2);if(!KindleHostDeviceDetector.isMetro()||!h||!a(f,"1.0.2.0","1.0.2.99"))return c.resolve(!1).promise();f="/kcrservice/checkBLCountry?lang="+b;d&&(f+="&ip="+d);$.ajax({url:f,dataType:"json"}).then(function(a){c.resolve(a?a.value:!1)},function(){c.resolve(!1)});return c.promise()}}}(),ResourceBundle=function(a,f){function b(a){return!a||!g[a.toUpperCase()]?"":a.toUpperCase()}function d(a){return!a?"":q[a]?a:a.length===2&&x[a]?x[a]:(a=x[a.substr(0,
2).toLowerCase()])?a:""}function c(){KindleAssert(o,"Language and culture must be set before calling getLanguage");return o.substr(0,2).toLowerCase()}function h(){KindleAssert(w,"Language and culture must be set before calling getFormatRegion");return w}function k(a,b){function d(a,j){var n=b[j];delete b[j];return n}for(var c=/\$\{([A-Za-z0-9_]+)\}/g,b=$.extend({},b),n;c.exec(a)&&n!==a;)n=a,a=a.replace(c,d);return a}function m(a){return a&&a.length>=5?a.substr(3,2).toUpperCase():""}function p(){return navigator&&
(navigator.language||navigator.userLanguage)?navigator.language||navigator.userLanguage:""}var q=a,g=f,r=!1,t,o,w,s=-(new Date).getTimezoneOffset(),x={de:"de-DE",en:"en-US",es:"es-ES",fr:"fr-FR",it:"it-IT",pt:"pt-BR",ja:"ja-JP",zh:"zh-CN"},H={"amazon.com":"en-US","amazon.com.au":"en-AU","amazon.co.uk":"en-GB","amazon.in":"en-IN","amazon.ca":"en-CA","amazon.de":"de-DE","amazon.fr":"fr-FR","amazon.it":"it-IT","amazon.es":"es-ES","amazon.com.mx":"es-MX","amazon.com.br":"pt-BR","amazon.co.jp":"ja-JP",
"amazon.cn":"zh-CN"},J=function(a,b){if(r)return a;if(q[b])return q[b][a]},y={en:["the ","a ","an "],de:["die ","der ","das ","des ","dem ","den ","ein ","eine ","einer ","einem ","einen "],es:["el ","la ","los ","las ","un ","una ","unos ","unas "],pt:["o ","a ","os ","as ","um ","uma ","uns ","umas "],fr:["le ","la ","l'","les ","un ","une ","des "],it:["il ","lo ","la ","l'","i ","gli ","le ","un ","uno ","una ","un'"]},D={da:["og","i","jeg","det","at","en","den","til","er","som","p\u00e5","de",
"med","han","af","for"],de:["der","die","das","des","dem","den","ein","eine","einer","einem","einen","dies","diese","diesem","diesem","diesen","dieser","dieses","ich","du","er","sie","es","wir","ihr","sie","Sie","als","an","ans","auch","auf","aufs","aus","bei","fuer","f\u00fcr","nicht","nur","oder","so","und","um","ums","vom","von","in","im"],en:["the","a","an","this","that","these","those","i","you","she","he","it","we","they","as","like","at","to","also","on","of","by","for","not","only","or","so",
"and","about","from","in"],es:["el","la","los","las","un","una","unos","unas","del","al","este","ese","aquel","estos","esos","aquellos","esta","esa","aquella","estas","esas","aquellas","yo","t\u00fa","tus","vos","usted","\u00e9l","ella","ello","nosotros","nosotras","vosotros","vosotras","ustedes","ellos","ellas","en","y","o","a","por","no","ni","desde","e"],fi:["olla","olen","olet","on","olemme","olette","ovat","ole","se","sen","sit\u00e4","siin\u00e4","siit\u00e4","siihen","sill\u00e4","silt\u00e4",
"sille","sin\u00e4","siksi","kanssa"],fr:["le","la","l'","les","un","une","des","du","de","au","aux","ce","cet","cette","ces","je","tu","elle","il","on","nous","vous","elles","ils","comme","\u00e0","aussi","sur","par","pour","ne","n\u2019","pas","ou","or","donc","et","dans"],hu:["a","az","egy","be","ki","le","fel","meg","el","\u00e1t","r\u00e1","ide","oda","sz\u00e9t","\u00f6ssze","vissza","de","h\u00e1t","\u00e9s","vagy","hogy","van","lesz","volt","csak","nem","igen","mint","\u00e9n","te","\u00f5",
"mi","ti","\u00f5k","\u00f6n"],it:["il","lo","la","l'","i","gli","le","un","uno","una","un'","del","dello","della","dell'","dei","degli","degl'","delle","questo","questa","questi","queste","quello","quella","quelli","codesto","codesta","codesti","codeste","io","noi","tu","voi","egli","esso","essi","ella","essa","esse","ad","al","allo","agli","all","agl","alla","alle","con","col","coi","da","dal","dallo","dai","dagli","dall","dagl","dalla","dalle","di","del","dello","dei","degli","dell","degl","della",
"delle","in","nel","nello","nei","nell","negl","nella","nelle","su","sul","sullo","sui","sugli","sull","sugl","sulla","sulle","per","ed","anche","non","a","e","o"],nl:["de","en","van","ik","te","dat","die","in","een","hij","het","niet","zijn","is","was","op","aan","met","als","voor","had","er"],no:["at","en","et","den","til","er","p\u00e5","med","han","av","var","ved","fra","bli","ble","blei","blitt","v\u00e6re","kom","for","\u00e5","blir","v\u00e6rt","v\u00e6re","d\u00e5","ein","eit","eitt","vere",
"vore","verte","vort","varte","vart"],pt:["o","a","os","as","um","uma","uns","umas","esta","estes","estas","aquele","aquela","aqueles","aqueles","aquelas","isto","aquilo","eu","voc\u00ea","ele","ela","n\u00f3s","v\u00f3s","voc\u00eas","eles","elas","de","a","e","em","para","n\u00e3o","no","na","por","como","ou"],ro:["o","unui","unei","unor","cel","cea","cei","cele","celui","celei","celor","al","a","ai","ale","pe","la","\u00een","f\u0103r\u0103","sub","despre","c\u0103tre","cu","de","din","l\u00e2ng\u0103",
"spre","ca","sunt","s","e\u015fti","este","e","suntem","sunte\u0163i","eram","erai","era","era\u0163i","erau","fiu","fii","fie","fim","fi\u0163i","fi","fiind","fost"],sv:["och","det","att","i","en","jag","hon","som","han","p\u00e5","den","med","var","sig","f\u00f6r","s\u00e5","till","\u00e4r","men","ett","om","hade","de","av"],tr:["acaba","altm\u00fd\u00fe","alt\u00fd","ama","bana","baz\u00fd","belki","ben","benden","beni","benim","be\u00fe","bin","bir","biri","birka\u00e7","birkez","bir\u00feey",
"bir\u00feeyi","biz","bizden","bizi","bizim","bu","buna","bunda","bundan","bunu","bunun","da","daha","dahi","de","defa","diye","doksan","dokuz","d\u00f6rt","elli","en","gibi","hem","hep","hepsi","her","hi\u00e7","iki","ile","INSERmi","ise","i\u00e7in","katrilyon","kez","ki","kim","kimden","kime","kimi","k\u00fdrk","milyar","milyon","mu","m\u00fc","m\u00fd","nas\u00fdl","ne","neden","nerde","nerede","nereye","niye","ni\u00e7in","on","ona","ondan","onlar","onlardan","onlari","onlar\u00fdn","onu","otuz",
"sanki","sekiz","seksen","sen","senden","seni","senin","siz","sizden","sizi","sizin","trilyon","t\u00fcm","ve","veya","ya","yani","yedi","yetmi\u00fe","yirmi","y\u00fcz","\u00e7ok","\u00e7\u00fcnk\u00fc","\u00fc\u00e7","\u00feey","\u00feeyden","\u00feeyi","\u00feeyler","\u00feu","\u00feuna","\u00feunda","\u00feundan","\u00feunu"]};return{initialize:function(a,c){var k=H[Kindle.URL.getAmazonDomain()];o=d(a)||d(p())||d(k)||"en-US";w=b(c)||b(m(o))||"US";k=c&&c.toUpperCase()||m(a)||m(p())||m(k)||"US";
t=o.substr(0,2).toLowerCase()+"-"+k},getFormatRegion:h,getUserLanguageCulture:function(){KindleAssert(t,"Language and culture must be set before calling getUserLanguageCulture");return t},getLanguage:c,getLocalizedString:function(a,b,c){var g=o;c&&(g=d(c));c=J(a,g);typeof c!=="string"&&(g!=="en-US"&&(c=J(a,"en-US")),c||(c=a));b&&(c=k(c,b));return c},getLocalizedTime:function(a){return $.format.date(a,g[h()].k_format_time,c())},getLocalTimeOffset:function(){return s},getLocalizedDate:function(a){return $.format.date(a,
g[h()].k_format_date,c())},getLocalizedDateTime:function(a){return $.format.date(a,g[h()].k_format_date_time,c())},getLocalizedArticles:function(){return y[c()]||[]},getLocalizedSearchStopWords:function(a){a=a||c();return D[a]||[]},isLanguageEN:function(){return o.substring(0,2)==="en"},setStringIDMode:function(a){r=!!a},languageCultureNameToRegion:m}}(Kindle.strings,Kindle.formats),KindleO_Aaa=function(){function a(a){for(var b=[],c,q,g,f,h,o,w=0;w<a.length;)g=a.charCodeAt(w++)&255,c=a.charCodeAt(w++),
f=c&255,q=a.charCodeAt(w++),h=q&255,o=g>>2,g=(g&3)<<4|f>>4,f=(f&15)<<2|h>>6,h&=63,isNaN(c)?f=h=64:isNaN(q)&&(h=64),b.push(d.charAt(o)+d.charAt(g)+d.charAt(f)+d.charAt(h));return b.join("")}function f(a){for(var b=[],d,f,g,h,t,o=0;o<a.length;)d=c[a.charCodeAt(o++)],f=c[a.charCodeAt(o++)],h=c[a.charCodeAt(o++)],t=c[a.charCodeAt(o++)],d=d<<2|f>>4,f=(f&15)<<4|h>>2,g=(h&3)<<6|t,b.push(String.fromCharCode(d)),h!==64&&b.push(String.fromCharCode(f)),t!==64&&b.push(String.fromCharCode(g));return b.join("")}
function b(a,b){var d=[];d.length=256;for(var c=0;c<256;c++)d[c]=c;for(var g=0,f,c=0;c<256;c++)g=g+d[c]+b[c%b.length]&255,f=d[c],d[c]=d[g],d[g]=f;for(var g=c=0,h=[],o=0;o<a.length;o++)c=c+1&255,g=g+d[c]&255,f=d[c],d[c]=d[g],d[g]=f,h.push(String.fromCharCode(a.charCodeAt(o)^d[d[c]+d[g]&255]));return h.join("")}for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=[],h=0;h<d.length;h+=1)c[d.charCodeAt(h)]=h;return{o_aaa:a,o_aag:f,o_aac:function(c,d){var f;f=c.replace(/\x0d\x0a/g,
"\n");for(var q=[],g=0;g<f.length;g++){var r=f.charCodeAt(g);r<128?q.push(String.fromCharCode(r)):(r>127&&r<2048?q.push(String.fromCharCode(r>>6|192)):(q.push(String.fromCharCode(r>>12|224)),q.push(String.fromCharCode(r>>6&63|128))),q.push(String.fromCharCode(r&63|128)))}f=q.join("");q=d;q+="00000000000000000000000000000000".substring(0,32-q.length);g=[];for(h=0;h<q.length;h+=2)g.push(parseInt(q.substring(h,h+2),16));return a(b(f,g))},o_aad:function(a,c){for(var d=f(a),h=[],g=0;g<c.length;g++)h.push(c.charCodeAt(g));
for(var d=b(d,h),h=[],g=0,r,t,o;g<d.length;)r=d.charCodeAt(g),r<128?(h.push(String.fromCharCode(r)),g++):r>191&&r<224?(t=d.charCodeAt(g+1),h.push(String.fromCharCode((r&31)<<6|t&63)),g+=2):(t=d.charCodeAt(g+1),o=d.charCodeAt(g+2),h.push(String.fromCharCode((r&15)<<12|(t&63)<<6|o&63)),g+=3);return h.join("")}}}(),KindleAppDb=function(a){function f(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb()}function b(a){var b=new jQuery.Deferred;h.getRecord("keyValue",{key:a}).then(function(a){a&&
a.length>0&&b.resolve(a[0].value);b.reject()},b.reject);return b.promise()}function d(a,b){return h.upsertRecord("keyValue",{value:b},{key:a})}function c(a){return h.deleteRecord("keyValue",{key:a})}var h=a;a.updateBookData=function(a,b,d){var c,g,r=[],t=[];for(c in a)t.push(a[c].asin),r.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a[c].asin}]});for(c in b)a=b[c],r.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"bookdata",params:[a,{asin:a.asin}]});
g=r.length;d&&r.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"keyValue",params:[{value:String(d)},{key:"synctime"}]});return h.batchTransaction(r).pipe(function(){function a(){return g}return t.length<1||!f()?(new jQuery.Deferred).resolve(g):f().deleteBooksData(t).pipe(a,a)})};a.getAllBooks=function(){return h.getRecord("bookdata")};a.getAllBooksForContentType=function(a){return h.getRecord("bookdata",{contentType:a})};a.getBook=function(a,b){h.getRecord("bookdata",{asin:a}).done(function(a){b(a.length>
0?a[0]:{})})};a.getBookDataLastSyncTime=function(a){b("synctime").done(function(b){a(b?b:Kindle.DB.NEVER)}).fail(function(){a(Kindle.DB.NEVER)})};a.updateLastPositionRead=function(a,b,d,c){h.updateRecord("bookdata",{lastPositionRead:b,lastTimeRead:d},{asin:a}).fail(c)};a.updateLastFPRSyncTime=function(a,b,d){h.updateRecord("bookdata",{lastFPRSyncTime:b},{asin:a}).fail(d)};a.updateLastReadTime=function(a,b,d,c){h.upsertRecord("bookdata",{lastTimeRead:b,lastFPRSyncTime:d},{asin:a}).fail(c)};a.updateMaxPosition=
function(a,b,d){h.updateRecord("bookdata",{maxPosition:b},{asin:a}).fail(d)};a.getDeviceToken=function(){return b(Kindle.Service.DeviceTokenKey)};a.setDeviceToken=function(a){return d(Kindle.Service.DeviceTokenKey,a)};a.clearDeviceToken=function(){return c(Kindle.Service.DeviceTokenKey)};a.getUserHashId=function(){return b(Kindle.Service.UserHashIdKey)};a.setUserHashId=function(a){return d(Kindle.Service.UserHashIdKey,a)};a.clearUserHashId=function(){return c(Kindle.Service.UserHashIdKey)};a.getEID=
function(){return b(Kindle.Service.EidKey)};a.setEID=function(a){return d(Kindle.Service.EidKey,a)};a.clearEID=function(){return c(Kindle.Service.EidKey)};a.getValueForKey=b;a.setValueForKey=d;a.removeValueForKey=c;a.getValuesForKeys=function(a){for(var b=[],d=new jQuery.Deferred,c=0;c<a.length;c++)b.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"keyValue",params:[{key:a[c]}]});h.batchTransaction(b).then(function(a){for(var b,c={},f=0;f<a.length;f++)if(a[f]&&a[f].length)b=a[f][0],c[b.key]=
b.value;d.resolve(c)},d.reject);return d.promise()};a.getCachedAsins=function(a,b){function d(b){var g,f=[];for(g=0;g<b.length;g++)a.indexOf(b[g].cacheState)>=0&&f.push(b[g]);c.resolve(f)}var c=jQuery.Deferred();if(f()){var g={asin:!0,cacheState:!0,cachedSize:!0,context:!!b};f().getRecord("bookinfo",null,g).then(a?d:c.resolve,c.reject)}else c.resolve([]);return c.promise()};a.getCachedCovers=function(){function a(c){var d,g={};for(d=0;d<c.length;d++)g[c[d].asin]=c[d].coverData;b.resolve(g)}var b=
new jQuery.Deferred;f()?f().getRecord("covers",null).then(a,b.reject):a([]);return b.promise()};a.getBookCachedState=function(a){return f()?f().getRecord("bookinfo",{asin:a},{cacheState:!0}):(a=new jQuery.Deferred,a.resolve([]),a.promise())};a.getPinnedSessionIds=function(){function a(b){var c,f=[];if(b)for(c=0;c<b.length;c++)f.push(b[c].context.kindleSessionId);d.resolve(f)}function b(){d.resolve([])}var d=new jQuery.Deferred;f()?f().getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},
{context:!0}).then(a,b):d.resolve([]);return d.promise()};return a},KindleBookDb=function(a){function f(){switch(KindleHostDeviceDetector.getDevicePlatform()){case "iPad":case "iPhone":case "playBook":return 5E7;case "desktop":return KindleHostDeviceDetector.isIE()?25E7:Number.MAX_VALUE;default:return 5E7}}function b(a,b){var d={},c;for(c in a)a.hasOwnProperty(c)&&!b[c]&&(d[c]=a[c]);d=JSON.stringify(d);return d==="{}"?"":d}function d(a,b){if(b){var d=JSON.parse(b),c;for(c in d)d.hasOwnProperty(c)&&
(a[c]=d[c])}return a}function c(a,b,c,d,e,f){var g=Date.now();A.getRecord(a,{asin:c,id:{operator:Kindle.DB.IN_ARRAY,values:d}}).then(function(a){b(a,g,e)},function(a){f(a)})}function h(a,b,c,d,e,f){Date.now();var g=0,h,k=[],s;for(s in d)h=b(c,d[s]),g+=h.size,k.push(h);A.insertList(a,k).then(function(){Date.now();e(g)},function(a){f(a)})}function k(a,b,d,c){var e=KindleMetricsProfiler("getIds:"+a);A.getPieceIds(a,b).then(function(a){e.addCount(b,a.length);e.endTimer();e.log();d(a)},function(a){c(a)})}
function m(a,b,c){Date.now();var b=[],f=0,e;for(e in a){var g=a[e],h=g.id;f+=g.piece.length+g.metadata.length;b[h]=d({fragmentData:g.piece,fragmentMetadata:JSON.parse(g.metadata)},g.other)}c(b)}function p(a,c){var d=c.fragmentData,g=JSON.stringify(c.fragmentMetadata),e=b(c,{fragmentData:1,fragmentMetadata:1});return{asin:a,id:c.fragmentMetadata.id,size:d.length+g.length+e.length,piece:d,metadata:g,other:e}}function q(a,b,c){Date.now();var b=[],g;for(g in a){var e=a[g];b[e.id]=d({skeletonData:e.piece,
skeletonMetadata:JSON.parse(e.metadata)},e.other)}c(b)}function g(a,c){var d=c.skeletonData,g=JSON.stringify(c.skeletonMetadata),e=b(c,{skeletonData:1,skeletonMetadata:1});return{asin:a,id:c.skeletonMetadata.id,size:d.length+g.length+e.length,piece:d,metadata:g,other:e}}function r(a,b,c){Date.now();var b=[],g=0,e;for(e in a){var f=a[e],h=f.id;g+=f.piece.length+f.metadata.length;b[h]=d({glyphData:JSON.parse(f.piece),glyphFragmentMetadata:JSON.parse(f.metadata)},f.other)}c(b)}function t(a,c){var d=
JSON.stringify(c.glyphData),g=JSON.stringify(c.glyphFragmentMetadata),e=b(c,{glyphData:1,glyphFragmentMetadata:1});return{asin:a,id:c.glyphFragmentMetadata.id,size:d.length+g.length+e.length,piece:d,metadata:g,other:e}}function o(a,b,c){Date.now();var b=[],g=0,e;for(e in a){var f=a[e],h=f.id;g+=f.piece.length+f.metadata.length;b[h]=d({data:JSON.parse(f.piece),metadata:JSON.parse(f.metadata)},f.other)}c(b)}function w(a,c){var d=JSON.stringify(c.data),g=JSON.stringify(c.metadata),e=b(c,{data:1,metadata:1});
return{asin:a,id:c.metadata.id,size:d.length+g.length+e.length,piece:d,metadata:g,other:e}}function s(a,b,c){Date.now();var b=[],g=0,e;for(e in a){var f=a[e],h=f.id;g+=f.piece.length+f.metadata.length;b[h]=d({locations:JSON.parse(f.piece),metadata:JSON.parse(f.metadata)},f.other)}c(b)}function x(a,c){var d=JSON.stringify(c.locations),g=JSON.stringify(c.metadata),e=b(c,{locations:1,metadata:1});return{asin:a,id:c.metadata.id,size:d.length+g.length+e.length,piece:d,metadata:g,other:e}}function H(a){return A.dbDeleteBooksData(a)}
function J(a){return A.dbGetBookStatistics(a)}function y(){var a=new jQuery.Deferred;A.getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{cachedSize:!0}).then(function(b){var c=0,d;for(d in b)c+=b[d].cachedSize;a.resolve(c)},function(){a.reject()});return a.promise()}function D(){var a=new jQuery.Deferred,b=f();b===Number.MAX_VALUE?a.resolve(Number.MAX_VALUE):y().then(function(c){c=b-1E6-c*2.4;c=Math.round(c/2.4);a.resolve(c)},function(){a.resolve(0)});return a.promise()}function I(b){function d(){var a=
new jQuery.Deferred;D().then(function(b){f=b;a.resolve(b)},function(){f=0;a.resolve()});return a.promise()}var j=0,f=0;return{getFragments:function(a){var d=new jQuery.Deferred;c("fragments",m,b,a,d.resolve,d.reject);return d.promise()},putFragments:function(a){var c=new jQuery.Deferred;h("fragments",p,b,a,function(a){j+=a;c.resolve(a)},c.reject);return c.promise()},getFragmentIds:function(){var a=new jQuery.Deferred;k("fragments",b,a.resolve,a.reject);return a.promise()},getSkeletons:function(a){var d=
new jQuery.Deferred;c("skeleton",q,b,a,d.resolve,d.reject);return d.promise()},putSkeletons:function(a){var c=new jQuery.Deferred;h("skeleton",g,b,a,function(a){j+=a;c.resolve(a)},c.reject);return c.promise()},getSkeletonIds:function(){var a=new jQuery.Deferred;k("skeleton",b,a.resolve,a.reject);return a.promise()},getGlyphs:function(a){var d=new jQuery.Deferred;c("glyphs",r,b,a,d.resolve,d.reject);return d.promise()},putGlyphs:function(a){var c=new jQuery.Deferred;h("glyphs",t,b,a,function(a){j+=
a;c.resolve(a)},c.reject);return c.promise()},getGlyphIds:function(){var a=new jQuery.Deferred;k("glyphs",b,a.resolve,a.reject);return a.promise()},getResources:function(a){var d=new jQuery.Deferred;c("resources",o,b,a,d.resolve,d.reject);return d.promise()},putResources:function(a){var c=new jQuery.Deferred;h("resources",w,b,a,function(a){j+=a;c.resolve(a)},c.reject);return c.promise()},getResourceIds:function(){var a=new jQuery.Deferred;k("resources",b,a.resolve,a.reject);return a.promise()},getLocationMaps:function(a){var d=
new jQuery.Deferred;c("locations",s,b,a,d.resolve,d.reject);return d.promise()},putLocationMaps:function(a){var c=new jQuery.Deferred;h("locations",x,b,a,function(a){j+=a;c.resolve(a)},c.reject);return c.promise()},getLocationMapIds:function(){var a=new jQuery.Deferred;k("locations",b,a.resolve,a.reject);return a.promise()},getAnnotations:function(){return A.getRecord("annotationsCache",{asin:b},{annotationsData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].annotationsData})},putAnnotations:function(a){return A.insertRecord("annotationsCache",
{asin:b,annotationsData:a})},getBookInfo:function(){var a=new jQuery.Deferred;A.getRecord("bookinfo",{asin:b}).then(function(b){b.length===1?(j=b[0].cachedSize||0,a.resolve(b[0])):a.reject()},a.reject);return a.promise()},insertBookInfo:function(a){a=$.extend(!0,{},a,{asin:b,openTime:Date.now()});return A.insertRecord("bookinfo",a)},updateBookInfo:function(a){a=$.extend({openTime:Date.now()},a);return A.updateRecord("bookinfo",a,{asin:b})},getBookStatistics:function(){var a=new jQuery.Deferred;J(b).then(function(c){c.totalSize!==
c.cachedSize?(j=c.cachedSize=c.totalSize,A.updateRecord("bookinfo",{cachedSize:j},{asin:b}).then(function(){a.resolve(c)},a.reject)):a.resolve(c)},a.reject);return a.promise()},getCacheQuota:function(){return{cachedSize:j,cacheQuota:f}},computeCacheQuota:function(){return d().promise()},deleteOldestBookData:function(b){return a.deleteOldestBookData(b)},deleteBooksData:function(b){return a.deleteBooksData(b)},deleteSearchIndex:function(){return A.deleteRecord("searchIndex",{asin:b})},getPageNumbers:function(){return A.getRecord("pageNumberCache",
{asin:b},{pageNumberData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].pageNumberData})},putPageNumbers:function(a){return A.insertRecord("pageNumberCache",{asin:b,pageNumberData:a})},getSearchIndex:function(){return A.getSearchIndexData(b)},putSearchIndex:function(a){return A.putSearchIndexData(b,a)},reserveStorage:function(a){function b(){f=setTimeout(function(){f=null;A.dropTable(d)},1E3)}function c(){var a=new ArrayBuffer(j*1024),a=new Blob([a]);A.insertRecord(d,{asin:"0000000000",id:g,
data:a}).then(function(){f&&(clearTimeout(f),--g>0?(b(),c()):A.dropTable(d))},function(){f&&(clearTimeout(f),A.dropTable(d))})}var d="reservedStorage",j=100,g=a*1024/j,f;b();c()},getFilteredSearchIndexAsins:function(a){var b=$.Deferred();A.getRecord("searchIndex",{asin:{operator:Kindle.DB.IN_ARRAY,values:a}},{asin:!0}).then(function(a){a=a.map(function(a){return a.asin}).sort().filter(function(a,b,c){return b===0||c[b-1]!==c[b]});b.resolve(a)},b.reject);return b.promise()}}}var A=a,z=null,C=0;a.deleteBooksData=
H;a.deleteOtherBooksData=function(a){for(var b=new jQuery.Deferred,c=["fragments","glyphs","skeleton","bookinfo","annotationsCache","covers","searchIndex","pageNumberCache"],d=[],e=0;e<c.length;e++)d.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:c[e],params:[{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]}}]});A.batchTransaction(d).then(function(){b.resolve()},function(a){b.reject(a)});return b.promise()};a.deleteOldestBookData=function(a){function b(){z.resolve(arguments);z=null}function c(){z.reject(arguments);
z=null}function d(e){function f(a){for(var b=function(){return a&&a.length>0?e.filter(function(b){return a.indexOf(b.asin)>=0}):e}(),c=b[0],d=1;d<b.length;d++)b[d].openTime<c.openTime&&(c=b[d]);return c.asin}function g(){H([f()]).then(b,c)}if(!e||e.length===0)KindleHostDeviceDetector.isIE()&&C===0?(b(),C++):(KindleDebug.warn("trying to delete oldest asin, but got no list of books"),C=0,c());else{C=0;var h=e.map(function(a){return a.asin});I(a).getFilteredSearchIndexAsins(h).done(function(a){a&&a.length>
0?I(f(a)).deleteSearchIndex().then(b,c):g()}).fail(g)}}z||(z=new jQuery.Deferred,A.getOldBookList(a).then(d,c));return z};a.getBookStatistics=J;a.updateBookInfos=function(a){var b=[],c;for(c in a){var d={},e;for(e in a[c])d[e]=a[c][e];b.push({operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[d,{asin:c}]})}return A.batchTransaction(b)};a.BookInfoDB=I;return a},KindleDBClient=function(){function a(){if(!J)throw{name:"databaseInitializationError",message:"Please call initialize function first"};
}function f(a){var b=$.extend({appDb:D},a);x.callEventListeners(a.type,b)}function b(a){var b=$.extend({bookDb:I},a);x.callEventListeners(a.type,b)}function d(a){var b=new jQuery.Deferred;a.wrapper?a.wrapper.dropTables().then(b.resolve,b.reject,b.notify):b.resolve();return b.promise()}function c(a){if(y)return y.promise();y=new jQuery.Deferred;K.initDfd=new jQuery.Deferred;var b=KindleStubDBWrapper(N);r(!1);b.createTables(P,K.version).then(function(){k(b);KindleAppDb(b);K.wrapper=b;K.initDfd.resolve(b);
A=D=b;J=!0;y.resolve(a)},function(a){y.reject(a)});return y.promise()}function h(){function a(){++j===e&&(A=null,KindleStubDBWrapper(N).dropTables(),c.resolve())}function b(d){return function(b){var e=[],j;for(j in b)e.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:d,params:[b[j],b[j]]});D.batchTransaction(e).then(a,c.reject)}}var c=new jQuery.Deferred;if(!A)return c.resolve(),c.promise();var d=A.getTableNames(),e=d.length,j=0,f;for(f in d)A.getRecord(d[f]).then(b(d[f]),c.reject);return c.promise()}
function k(a){function b(c){return{tableName:c,insertRecord:function(b){return a.insertRecord(c,b)},insertList:function(b){return a.insertList(c,b)},updateRecord:function(b,d){return a.updateRecord(c,b,d)},getRecord:function(b,d){return a.getRecord(c,b,d)},deleteRecord:function(b){return a.deleteRecord(c,b)},batchTransaction:function(b){var d;for(d=0;d<b.length;d++)b[d].tableName=c;return a.batchTransaction(b)}}}var c=a.getTableNames(),d,e;for(e in c)d=c[e],M[d]=b(d);a.getTable=function(a){return M[a]}}
function m(a){a.onversionchange=function(a){K.handle&&K.handle.close();L.handle&&L.handle.close();a&&a.target&&a.target.close&&typeof a.target.close==="function"&&a.target.close();setTimeout(function(){function a(){window.location.reload(!0)}_metricsManager.emitNow("App::DatabaseGoneOnVersionZero",{breakdown:["Browser"]}).then(a,a)},500)}}function p(){function a(){k(b);KindleAppDb(b);K.wrapper=b;K.initDfd.resolve(b)}var b={};if(!K.initDfd)K.initDfd=new jQuery.Deferred,KindleHostDeviceDetector.isWebSQLSupported()?
(b=KindleSqlWrapper(K),b.flavor="websql",b.openDatabase().then(function(b){K.handle=b;a();KindleLocalStorage.setItem("haveDB","1")},K.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(K),b.flavor="IndexedDB",b.openDatabase().done(function(b){m(b);K.handle=b;KindleLocalStorage.setItem("haveDB","1");a()}).fail(K.initDfd.reject)):c(this);return K.initDfd.promise()}function q(){function a(){k(b);KindleBookDb(b);L.wrapper=b;L.initDfd.resolve(b)}var b={};if(!L.initDfd){L.initDfd=
new jQuery.Deferred;try{KindleHostDeviceDetector.isWebSQLSupported()?(b=KindleSqlWrapper(L),b.openDatabase().then(function(c){L.handle=c;a(b)},L.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(L),b.openDatabase().done(function(b){m(b);L.handle=b;a()}).fail(L.initDfd.reject)):L.initDfd.reject("nodb")}catch(c){L.initDfd.reject()}}return L.initDfd.promise()}function g(){if(KindleHostDeviceDetector.isChromeApp())return!0;if((KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&
KindleLocalStorage.getItem("haveDB"))return!0;var a=KindleLocalStorage.getItem("booksdb");if(a==="true")return!0;else if(a==="false")return!1}function r(a){KindleLocalStorage.setItem("booksdb",a?"true":"false")}function t(){var a;a=new jQuery.Deferred;if(I)return a.resolve(I),a.promise();var b;b=!KindleHostDeviceDetector.isWebSQLSupported()&&!KindleHostDeviceDetector.isIndexedDBSupported()?!1:KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()?!1:!0;if(!b)return a.reject(),
a.promise();L.initDfd=null;q().then(function(b){I=b;r(!0);a.resolve(I)},function(){r(!1);a.reject()});return a.promise()}function o(){var a;a=new jQuery.Deferred;if(D&&D!==A)return a.resolve(D).promise();K.initDfd=null;p().then(function(b){D=b;a.resolve(D)},function(){a.reject()});return a.promise()}function w(){function a(){D=A;KindleLocalStorage.removeItem("haveDB");C=z.memAppDb}function b(){C=z.dbBookDb}function c(d){return h().pipe(function(){D=d;A=null;KindleLocalStorage.removeItem(N);C=z.dbAppDb;
return t().pipe(b)},a)}var d;switch(C){case z.dbBookDb:d=$.Deferred().resolve();break;case z.dbAppDb:d=t().pipe(b);break;case z.memAppDb:d=o().pipe(c,a)}return d.promise()}function s(){function a(b,c){D=b;C=(I=c)?z.dbBookDb:z.dbAppDb;J=!0;H.resolve(S)}function b(c){$.when(g()?q():null).then(function(b){C=z.dbBookDb;a(c,b)},function(){C=z.dbAppDb;a(c,null)})}function d(){C=z.memAppDb;c(S).done(H.resolve)}if(!H)H=new jQuery.Deferred,(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE()?
KindleLocalStorage.getItem("haveDB"):1)?p().then(b,d):(C=z.memAppDb,c(S).done(H.resolve));return H.promise()}var x=ListenerManager(),H=null,J=!1,y=null,D=null,I=null,A=null,z={none:"none",memAppDb:"memAppDb",dbAppDb:"dbAppDb",dbBookDb:"dbBookDb"},C=z.none,n=Kindle.DB.TEXT_TYPE,u=Kindle.DB.NUMBER_TYPE,j=Kindle.DB.OBJECT_TYPE,O=Kindle.DB.BLOB_TYPE,e=Kindle.DB.ALLOW_NULL,B=Kindle.DB.PRIMARY_KEY,Q=Kindle.DB.PIECE_ID_TYPE,N="app_db_storage",P={bookdata:{asin:n|B,contentType:n|e,title:n|e,authors:j|e,purchaseDate:u|
e,maxPosition:u|e,lastTimeRead:u|e,lastPositionRead:u|e,lastFPRSyncTime:u|e,authorPronunciations:j|e,titlePronunciation:n|e},keyValue:{key:n|B,value:n|e},metrics:{method:n,time:u,timers:j|e,counters:j|e,breakDown:j|e,kindleStream:j|e},journal:{id:Kindle.DB.AUTO_INCREMENT,entry:j}},n={bookinfo:{asin:n|B,cacheState:n|Kindle.DB.SECONDARY_KEY,cachedSize:u|e,openTime:u,context:j,metadata:j,manifest:j,fragmap:j},skeleton:{asin:n|B,id:u|B|Q,size:u,piece:n,metadata:n,other:n},fragments:{asin:n|B,id:u|B|Q,
size:u,piece:n,metadata:n,other:n},glyphs:{asin:n|B,id:u|B|Q,size:u,piece:n,metadata:n,other:n},resources:{asin:n|B,id:u|B|Q,size:u,piece:n,metadata:n,other:n},locations:{asin:n|B,id:u|B|Q,size:u,piece:n,metadata:n,other:n},annotationsCache:{asin:n|B,annotationsData:j},covers:{asin:n|B,coverData:n},searchIndex:{asin:n|B,component:n|B,data:O},pageNumberCache:{asin:n|B,pageNumberData:j},reservedStorage:{asin:n|B,id:n|B,data:O}},M={},K={shortName:"K4W",version:3,displayName:"Kindle Cloud Reader",defaultSize:5E6,
initDfd:null,wrapper:null,handle:null,tables:P,versionUpdate:[{version:2,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["contentType"]},{version:2,tableName:"bookdata",operation:Kindle.DB.UPDATE_RECORD_OPERATION,params:[{contentType:"EBOK"}]},{version:3,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["authorPronunciations","titlePronunciation"]},{version:4,tableName:"metrics",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["kindleStream"]}]},L={shortName:"K4Wbooks",
version:7,displayName:"Kindle Cloud Reader Books",defaultSize:5E7,initDfd:null,wrapper:null,handle:null,tables:n,versionUpdate:[{version:4,tableName:"bookinfo",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["manifest"]},{version:5,tableName:"searchIndex",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[n.searchIndex]},{version:6,tableName:"pageNumberCache",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[n.pageNumberCache]},{version:7,tableName:"reservedStorage",operation:Kindle.DB.CREATE_TABLE_OPERATION,
params:[n.reservedStorage]}]},S={enableFullDb:function(){return w(this)},getAppDb:function(){a();return D},getBookDb:function(){a();return I},bookDbEnabled:g,persistDB:function(){D&&D.persist&&D.persist();I&&I.persist&&I.persist()},clear:function(a,b){function c(){K.wrapper=null;D=K.initDfd=null;L.wrapper=null;A=I=L.initDfd=null;J=!1;y=_initializeFullDeferred=null;e.resolve()}var e=new jQuery.Deferred;(function(){function a(b){b=Number(b)||0;e.notify({clearDbAttempts:b});return K.wrapper.setValueForKey("clearDbAttempts",
b+1)}return K.wrapper.getValueForKey("clearDbAttempts").pipe(a,a)})().always(function(){d(K).then(function(){d(L).then(c,e.reject)},e.reject,e.notify)});e.then(a,b);return e.promise()},addEventListener:function(a,c){D&&D.addEventListener&&D.addEventListener(a,f);I&&I.addEventListener&&I.addEventListener(a,b);x.addEventListener(a,c)},removeEventListener:function(a,b){x.removeEventListener(a,b)}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.DB_CLIENT,[Kindle.MODULE.APPLICATION_ARGS],
s)}}}();
function KindleIDBWrapper(a){function f(a,b){b=b||{};b.type=b.type||a;Q.callEventListeners(a,b)}function b(a){if(!B[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function d(){var a=[],b;for(b in B)a.push(b);return a}function c(a,b,c){if(B[a].info[b]&Kindle.DB.PIECE_ID_TYPE){for(a=""+c;a.length<u;)a="0"+a;return a}else return c}function h(a,d){if(a&&d){b(d);var e=B[d],j="";if(e.genKeyPath)for(var e=e.keyList,f=0;f<e.length;++f){if(a[e[f]]===void 0){j=void 0;break}j+=
c(d,e[f],a[e[f]]);f<e.length-1&&(j+=n)}else j=a[e.keyPath];return j}}function k(a,b,d){for(var e="",j,f,g=0;g<b.length;++g){j=b[g];f=d[j];if(!f)break;f=f.hasOwnProperty(Kindle.DB.OPERATOR)?f[Kindle.DB.VALUES][0]:f;e+=c(a,j,f);g<b.length-1&&(e+=n)}return e}function m(a,b,d){var e="",j,f,g;for(g=0;g<b.length;++g){f=b[g];j=d[f];if(!j)throw{name:"CreateUpperBoundException",message:"Need at least the root primary key to create an upper bound"};if(j.hasOwnProperty(Kindle.DB.OPERATOR)){var h=j[Kindle.DB.VALUES][j[Kindle.DB.VALUES].length-
1];if(typeof h==="number")j=j[Kindle.DB.VALUES][j[Kindle.DB.VALUES].length-1];else if(typeof h==="string")j=h;else throw{name:"InvalidKeyException",message:"Tried to generate a lowerbound key with invalid keys"};}e+=c(a,f,j);g<b.length-1&&(e+=n)}return e}function p(a,b){for(var c=Date.now()-2E3,d=0;d<M.length;d++)if(M[d].id===a){M[d].time<c&&KindleDebug.log("Long write: "+(Date.now()-M[d].time));M.splice(d,1);break}M.length===0&&(clearInterval(S),S=null);K&&(K=!1,f(Kindle.ERROR.DB_LINGERING_WRITE,
{stalled:!1,writeOk:b}))}function q(){var a=Date.now()-5E3;M.some(function(b){return b.time<a&&!b.warned})&&(M.forEach(function(a){a.warned=!0}),K=!0,f(Kindle.ERROR.DB_LINGERING_WRITE,{stalled:!0}))}function g(a,b,c){var d,j=new jQuery.Deferred,f=new jQuery.Deferred,g=$.makeArray(a),n;c===P?(S||(S=setInterval(q,5E3)),M.push({id:++L,time:Date.now(),warned:K}),n=L):n=0;var h=n;try{d=e.transaction(g,c)}catch(k){return j.reject().promise()}d.oncomplete=function(){h&&p(h,!0);f.then(j.resolve,j.reject)};
d.onerror=function(a){h&&p(h,!1);j.reject(a)};d.onabort=function(){h&&p(h,!1);j.reject({code:Kindle.DB.QUOTA_ERR,message:"Assumed QUOTA_ERR"})};b(d,a,f);return j.promise()}function r(a,b,c){function d(){++e===j&&u.resolve(m)}for(var e=0,j=c.length,f=B[b].tableInfo,g=B[b].keyPath,n=B[b].genKeyPath,k=B[b].autoInc,u=new jQuery.Deferred,s,m=[],x=0;x<c.length;x++){for(var p in c[x])s=f[p],s&Kindle.DB.TEXT_TYPE?c[x][p]=typeof c[x][p]==="string"?c[x][p]:String(c[x][p]):s&Kindle.DB.NUMBER_TYPE&&(c[x][p]=
typeof c[x][p]==="number"?c[x][p]:Number(c[x][p]));!k&&!c[x][g]?(s=n?h(c[x],b):g,s=a.put(c[x],s)):s=k?a.add(c[x]):a.put(c[x]);s.onsuccess=d;s.onerror=u.reject;m.push(c[x])}return u.promise()}function t(a,c){if(!a||!c)throw{name:"databaseInsertError",message:"Tried to insert with an empty table name or empty object list"};b(a);return g(a,function(a,b,d){a=a.objectStore(b);r(a,b,c).then(d.resolve,d.reject)},P)}function o(a,c,d){function e(a,b){return a-b}b(c);var j=d?$.extend(!0,{},d):d,f,g=B[c].tableInfo,
n=B[c].keyPath,d=B[c].keyList,s=B[c].autoInc,u=new jQuery.Deferred,x=!1,p;if(j)for(var w in j){var r=j[w];if(r){var y=g[w],r=r.hasOwnProperty(Kindle.DB.OPERATOR);if(y&Kindle.DB.TEXT_TYPE)if(r){for(var q in j[w][Kindle.DB.VALUES])y=j[w][Kindle.DB.VALUES][q],j[w][Kindle.DB.VALUES][q]=typeof y==="string"?y:String(y);j[w][Kindle.DB.VALUES].sort()}else typeof j[w]!=="string"&&(j[w]=String(j[w]));else if(y&Kindle.DB.NUMBER_TYPE)if(r){for(var H in j[w][Kindle.DB.VALUES])y=j[w][Kindle.DB.VALUES][H],j[w][Kindle.DB.VALUES][H]=
typeof y==="number"?y:Number(y);j[w][Kindle.DB.VALUES].sort(e)}else typeof j[w]!=="number"&&(j[w]=Number(j[w]));!x&&r&&(x=!0)}}!x&&j&&(j[n]?f=j[n]:s||(f=h(j,c)));if(f)p=a.get(f),p.onsuccess=function(a){(a=a.target.result)?u.resolve([a]):u.resolve([])},p.onerror=u.reject;else{var t=[],o;if(j){f=!0;for(var O in d)if(!j[d[O]]){f=!1;break}if(f)f=k(c,d,j),c=m(c,d,j),c=IDBKeyRange.bound(f,c,!1,!1),p=a.openCursor(c);else{O={};for(var J in d)if(j[d[J]]){o=d[J];O[o]=j[o];break}if(!o){for(var D in j)if(j[D].hasOwnProperty(Kindle.DB.OPERATOR)){o=
D;O[D]=j[D];break}o||(o=Object.keys(j)[0])}O[o]&&O[o].hasOwnProperty(Kindle.DB.OPERATOR)?(f=k(c,[o],O),c=m(c,[o],O),c=IDBKeyRange.bound(f,c,!1,!1)):c=IDBKeyRange.only(j[o]);try{p=a.index(o).openCursor(c)}catch(z){p=a.openCursor()}}}else p=a.openCursor();p.onerror=u.reject;p.onsuccess=function(a){var a=a.target.result,b=!0;if(a){for(var c in j){var d=j[c];if(d){if(d.hasOwnProperty(Kindle.DB.OPERATOR))switch(b=$.inArray(a.value[c],d[Kindle.DB.VALUES])!==-1,d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b=
!b}else d!==a.value[c]&&(b=!1);if(!b)break}}b&&t.push(a.value);a["continue"]()}else u.resolve(t)}}return u.promise()}function w(a,b,c){var d=c[0],c=c[1],e=new jQuery.Deferred;o(a,b,c).then(function(c){if(c.length>0){for(var j in c)c[j]=$.extend(c[j],d);r(a,b,c).then(e.resolve,e.reject)}else e.resolve(c)},e.reject);return e.promise()}function s(a,b,c){return g(a,function(a,d,e){a=a.objectStore(d);w(a,d,[b,c]).then(e.resolve,e.reject)},P)}function x(a,b,c){var d=new jQuery.Deferred;w(a,b,c).then(function(e){e.length===
0?(c[0]=$.extend(c[0],c[1]),r(a,b,[c[0]]).then(d.resolve,d.reject)):d.resolve(e)},d.reject);return d.promise()}function H(a,b,c){return o(a,b,c[0])}function J(a,b,c){return g(a,function(a,d,e){a=a.objectStore(d);H(a,d,[b]).then(function(a){if(c)for(var b in a)for(var d in a[b])d in c||delete a[b][d];e.resolve(a)},e.reject)},N)}function y(a,b,c){function d(c){function f(){return function(){++g===c.length&&e.resolve()}}var g=0;if(c.length===0)e.resolve();else for(var n in c){var s=h(c[n],b);j=a["delete"](s);
j.onsuccess=f(s,c[n]);j.onerror=e.reject}}var c=c[0],e=new jQuery.Deferred,j;c?o(a,b,c).then(d,e.reject):(j=a.clear(),j.onsuccess=e.resolve,j.onerror=e.reject);return e.promise()}function D(a){for(var b=new jQuery.Deferred,c=e.transaction(a,P),d=0;d<a.length;d++)c.objectStore(a[d]).clear().onerror=b.reject;c.oncomplete=b.resolve;c.onabort=b.reject;c.onerror=b.reject;return b.promise()}function I(){var b=new jQuery.Deferred;e.onversionchange=function(){e.close();e=void 0};e.close();var c=window.indexedDB.deleteDatabase(a.shortName);
c.onsuccess=function(){b.resolve()};c.onerror=function(){b.reject()};c.onblocked=function(){b.notify({blocked:!0})};return b.promise()}function A(){return z(function(a){return a.value})}function z(a){return g("bookinfo",function(b,c,d){var e=[],b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=a(b);c&&e.push(c);b["continue"]()}else d.resolve(e)};b.onerror=d.reject},N)}function C(a){function b(a){u.reject(a)}function c(a){u.reject(a)}function f(a){if(a=a.target.result)a["delete"](),
a["continue"]()}function g(){}var n=d(),s,u,k,x,m,p,w,y;u=new jQuery.Deferred;p=e.transaction(n,P);p.oncomplete=function(){u.resolve()};p.onerror=b;p.onabort=b;for(k=0;k<a.length;++k){x=a[k];m=h({asin:x,id:0},"skeleton");y=h({asin:x,id:j},"skeleton");y=IDBKeyRange.bound(m,y);for(m=0;m<n.length;m++)s=B[n[m]],w=p.objectStore(n[m]),s.genKeyPath?(s=w.openCursor(y),s.onsuccess=f):(s=w["delete"](x),s.onsuccess=g),s.onerror=c}return u.promise()}var n=String.fromCharCode(31),u=8,j="99999999",O=a,e=null,B=
{},Q=ListenerManager(),N=IDBTransaction.READ_ONLY||"readonly",P=IDBTransaction.READ_WRITE||"readwrite",M=[],K=!1,L=1,S=null,T={};T[Kindle.DB.INSERT_LIST_OPERATION]=r;T[Kindle.DB.UPDATE_RECORD_OPERATION]=w;T[Kindle.DB.UPSERT_RECORD_OPERATION]=x;T[Kindle.DB.DELETE_RECORD_OPERATION]=y;T[Kindle.DB.GET_RECORD_OPERATION]=H;T[Kindle.DB.CREATE_TABLE_OPERATION]=function(){KindleDebug.error("Illegal function: doCreateTable")};if(!function(a){var b,c;for(c in a){b=c;var d=!0,e=!1,j=void 0,f=[],g=[],h="",s=[],
u=a[c],k=void 0;for(k in u){j=u[k];if(j&Kindle.DB.AUTO_INCREMENT||j&Kindle.DB.PRIMARY_KEY)e?d=!1:(e=!!(j&Kindle.DB.AUTO_INCREMENT))||f.push(k);j&(Kindle.DB.PRIMARY_KEY|Kindle.DB.SECONDARY_KEY)&&s.push({name:k,keyPath:k,unique:!1,multientry:!1})}if(d){for(var j=!1,m=0;m<f.length;++m)h+=f[m],g[m]=u[k],m<f.length-1&&(h+=n,j=!0);f.length===0&&(e=!0);B[b]={info:u,keyList:f,keyPath:h?h:void 0,genKeyPath:j,genKeyTypes:g,indexes:s,autoInc:e,tableInfo:u}}b=d;if(b&Kindle.DB.CONSTRAINT_ERROR)return!1}return!0}(a.tables))throw Error("Invalid table description for "+
a.shortName);return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},openDatabase:function(){var a=new jQuery.Deferred,b;window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;b=window.indexedDB.open(O.shortName,O.version);b.onsuccess=function(b){e=b.target.result;a.resolve(e)};b.onerror=function(b){a.reject(b)};b.onupgradeneeded=function(a){var c;
a:{c=O.tables;var a=a.target.result,d,e,j;j=a.objectStoreNames;for(d=0;d<j.length;d++)e=j[d],c.hasOwnProperty(e)||a.deleteObjectStore(e);for(e in c)if($.inArray(e,j)===-1){var f=a;d=e;if(B[d]===void 0)d=Kindle.DB.CONSTRAINT_ERR;else{var g={autoIncrement:B[d].autoInc};if(!g.autoIncrement&&!B[d].genKeyPath)g.keyPath=B[d].keyPath;var f=f.createObjectStore(d,g),n=g=void 0;for(n in B[d].indexes)g=B[d].indexes[n],f.createIndex(g.name,g.keyPath,{unique:g.unique});d=null}if(d&Kindle.DB.CONSTRAINT_ERR){c=
!1;break a}}c=!0}c||b.abort()};return a.promise()},dropTable:function(a){return D([a])},dropTables:function(){function a(){A().then(b,f)}function b(a){function e(){d(a).then(j,f)}a.length===0?j():c(a).then(e,f)}function c(a){function b(){++e===a.length&&d.resolve()}for(var d=new jQuery.Deferred,e=0,j=0;j<a.length;j++)s("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PARTIAL},{asin:a[j].asin}).then(b,d.reject);return d.promise()}function d(a){function b(){++e===a.length&&c.resolve()}for(var c=new jQuery.Deferred,
e=0,j=0;j<a.length;j++)C([a[j].asin]).then(b,c.reject);return c.promise()}function j(){D($.makeArray(e.objectStoreNames)).then(g.resolve,f)}function f(){KindleDebug.error("Error occured signing out");g.reject()}var g;if(window.indexedDB.deleteDatabase)return I();g=new jQuery.Deferred;e.name==="K4Wbooks"?$.when(D(["annotationsCache"]),D(["pageNumberCache"])).then(a,f):j();return g.promise()},getTableNames:d,insertRecord:function(a,b){return t(a,[b])},insertList:t,upsertRecord:function(a,b,c){return g(a,
function(a,d,e){a=a.objectStore(d);x(a,d,[b,c]).then(e.resolve,e.reject)},P)},updateRecord:s,getRecord:J,deleteRecord:function(a,b){return g(a,function(a,c,d){a=a.objectStore(c);y(a,c,[b]).then(d.resolve,d.reject)},P)},batchTransaction:function(a){if(!a||a.length===0){var c=new jQuery.Deferred;c.resolve([]);return c.promise()}var c=[],d=!0,e=[],j=0,f;for(f in a)$.inArray(a[f].tableName,c)===-1&&(b(a[f].tableName),c.push(a[f].tableName)),d&&a[f].operation!==Kindle.DB.GET_RECORD_OPERATION&&(d=!1);return g(c,
function(c,d,f){function g(b){return function(c){e[b]=c;++j===a.length?f.resolve(e):h()}}function n(){c.abort();f.reject()}function h(){(l=a[s])||f.reject();b(l.tableName);T[l.operation](c.objectStore(l.tableName),l.tableName,l.params).then(g(s),n);++s}var l,s=0;h();return f.promise()},d?N:P)},getPieceIds:function(a,c){b(a);return g(a,function(b,d,e){var f=[],g,b=b.objectStore(a),d=h({asin:c,id:0},a);g=h({asin:c,id:j},a);d=IDBKeyRange.bound(d,g);b=b.openCursor(d);b.onsuccess=function(a){var b;(a=
a.target.result)?(b=a.key.split(n),b=parseInt(b[1],10),f.push(b),a["continue"]()):e.resolve(f)};b.onerror=e.reject},N)},getOldBookList:function(a){return z(function(b){if(b.key!==a&&b.value.cacheState!==Kindle.BookInfo.CachedState.PINNED)return b.value})},dbGetBookStatistics:function(a){function b(a){n.reject(a)}function c(a){n.reject(a)}function f(a){u[a]={count:0,size:0};return function(b){(b=b.target.result)?(u[a].count++,u[a].size+=b.value.size,b["continue"]()):u.totalSize+=u[a].size}}var g=[];
$.each(d(),function(a,b){B[b]&&B[b].info.size&&g.push(b)});g.push("bookinfo");var n,s,u,k,m,x;n=new jQuery.Deferred;u={totalSize:0,cacheState:"",cachedSize:0};k=e.transaction(g,N);k.oncomplete=function(){n.resolve(u)};k.onerror=b;k.onabort=b;s=h({asin:a,id:0},g[0]);x=h({asin:a,id:j},g[0]);x=IDBKeyRange.bound(s,x);for(s=0;s<g.length-1;s++)u[g[s]]={count:0,size:0},m=k.objectStore(g[s]),m=m.openCursor(x),m.onsuccess=f(g[s]),m.onerror=c;m=k.objectStore("bookinfo");m=m.get(a);m.onsuccess=function(a){if(a=
a.target.result)u.cacheState=a.cacheState,u.cachedSize=a.cachedSize||0};m.onerror=c;return n.promise()},dbDeleteBooksData:C,getSearchIndexData:function(a){var b=$.Deferred(),c=KindleMetricsProfiler("retrieve db search index");J("searchIndex",{asin:a}).then(function(a){if(!a||!a.length)b.reject();else{var d={};a.forEach(function(a){d[a.component]=a.data});c.endTimer();c.log();b.resolve(d)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),d=KindleMetricsProfiler("save db search index"),
e=[];e.push({asin:a,component:"positions",data:b.positions});e.push({asin:a,component:"words",data:b.words});e.push({asin:a,component:"properties",data:b.properties});t("searchIndex",e).always(function(){d.endTimer();d.log();c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){return g("journal",function(b,c,d){b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=b.value,e;for(e in a)if(c.type===a[e].type&&(c.guid||c.refEmId)===(a[e].guid||a[e].refEmId)&&
c.start===a[e].start&&c.end===a[e].end&&c.position===a[e].position&&c.modifiedTimestamp===a[e].modifiedTimestamp&&c.asin===a[e].asin){delete a[e];b["delete"]();break}b["continue"]()}else d.resolve()};b.onerror=d.reject},P)},addEventListener:Q.addEventListener,removeEventListener:Q.removeEventListener}}
function KindleSqlWrapper(a,f){function b(a){if(!z[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function d(a,b){var c=new jQuery.Deferred,d=[];A[b?"readTransaction":"transaction"](function(b){a(b,d)},function(a){c.reject(a)},function(){c.resolve(d)});return c.promise()}function c(){var a=[],b;for(b in z)a.push(b);return a}function h(a,b,c){var d=[],e,f;for(f in a)e=b[f],e!==void 0?a[f]&Kindle.DB.OBJECT_TYPE?d.push(JSON.stringify(e)):a[f]&Kindle.DB.BLOB_TYPE?
d.push(I(e)):d.push(e):c&&!(a[f]&Kindle.DB.AUTO_INCREMENT)&&d.push(null);return d}function k(a,b){var c="",d,e;for(e in a)if(d=b[e])if(c+=(c?" AND ":"")+e,d.hasOwnProperty(Kindle.DB.OPERATOR))switch(d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:c+=" != ?";break;case Kindle.DB.IN_ARRAY:c+=" IN (?";for(var f=1;f<d[Kindle.DB.VALUES].length;f++)c+=", ?";c+=")"}else c+=" = ?";return c}function m(a){var b="";a&Kindle.DB.TEXT_TYPE||a&Kindle.DB.OBJECT_TYPE||a&Kindle.DB.BLOB_TYPE?b+="TEXT ":a&Kindle.DB.AUTO_INCREMENT?
b+="INTEGER PRIMARY KEY AUTOINCREMENT ":a&Kindle.DB.NUMBER_TYPE&&(b+="INTEGER ");!(a&Kindle.DB.PRIMARY_KEY)&&!(a&Kindle.DB.ALLOW_NULL)&&(b+="NOT NULL ");return b}function p(a,b){var c="DELETE FROM "+a;b&&(c+=" WHERE "+k(z[a],b));return c+";"}function q(a,b,c){if(c===void 0)c="*";else{var d=z[a],e="",f;for(f in d)c[f]&&(e+=(e?", ":"")+f);c=e}c="SELECT "+c+" FROM "+a;b&&(c+=" WHERE "+k(z[a],b));return c+";"}function g(a,c){b(a);if($.isArray(c)){if(c.length===0)return(new jQuery.Deferred).resolve().promise()}else return(new jQuery.Deferred).reject().promise();
return d(function(b){r(b,a,[c])},!1)}function r(a,b,c,d,e){var c=c[0],f,d=z[b],e="INSERT OR "+(e?"IGNORE":"REPLACE")+" INTO "+b+" (",g="",s="";for(f in d)d[f]&Kindle.DB.AUTO_INCREMENT||(g+=(g?", ":"")+f,s+=(s?", ":"")+"?");e+=g+") VALUES ("+s+");";f=e;b=z[b];for(e=0;e<c.length;e++)d=h(b,c[e],!0),a.executeSql(f,d)}function t(a,b,c,d,e){var d=c[0],c=c[1],f=z[b],g=z[b],s="",m;for(m in g)d[m]!==void 0&&(s+=(s?", ":"")+m+" = ?");b="UPDATE "+(e?"OR IGNORE ":"")+b+" SET "+s;c&&(b+=" WHERE "+k(g,c));b+=";";
d=h(f,d);c&&(d=d.concat(h(f,c)));a.executeSql(b,d)}function o(a,b,c){t(a,b,c,[],!0);r(a,b,[[$.extend({},c[0],c[1])]],[],!0)}function w(a,b){var c={},d,e,f;for(f in a)if(d=b[f],d!==void 0&&d!==null){e=a[f];var g=c,h=f;if(e&Kindle.DB.OBJECT_TYPE)d=JSON.parse(d);else if(e&Kindle.DB.BLOB_TYPE){e=d;d=e.slice(1);e.charAt(0)==="x"&&(d=KindleO_Aaa.o_aag(d));e=new ArrayBuffer(d.length);for(var s=new Uint8Array(e),k=0;k<d.length;k++)s[k]=d.charCodeAt(k);d=e}g[h]=d}return c}function s(a,c,f){b(a);return d(function(b,
d){H(b,a,[c,f],d)},!0)}function x(a){var b=[],c;if(a)for(var d in a)c=a[d],c.hasOwnProperty(Kindle.DB.VALUES)?b=b.concat(c[Kindle.DB.VALUES]):b.push(c);return b}function H(a,b,c,d){var e=c[0],f=z[b];a.executeSql(q(b,e,c[1]),x(e),function(a,b){if(b.rows.length>0)for(var c=0;c<b.rows.length;c++)d.push(w(f,b.rows.item(c)))})}function J(a,b,c){c=c[0];a.executeSql(p(b,c),x(c))}function y(a){return d(function(b,c){for(var d,e=0;e<a.length;e++)if(d=C[a[e].operation])c[e]=[],d(b,a[e].tableName,a[e].params,
c[e])},!1)}function D(a){var b,c=[];for(b in a)c.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:b,params:[a[b]]});return y(c)}function I(a){a=function(a){var b;b=a instanceof ArrayBuffer||Object.prototype.toString.call(a)==="[object ArrayBuffer]";if(!b)throw"[KindleSqlWrapper binaryToString] Unknown data type passed. Expect ArrayBuffer.";var c,d;if(KindleHostDeviceDetector.hasArrayLikeApply())try{var f=a.byteLength;b=f;for(c=[];b>=0;){var g=f-b,h=a.slice(g,Math.min(g+1E4,f));d=new Uint8Array(h);
c.push(String.fromCharCode.apply(null,d));b-=1E4}}catch(s){c=null}if(!c){c=[];d=new Uint8Array(a);for(a=0;a<d.length;a++)c.push(String.fromCharCode(d[a]))}return c.join("")}(a);return a.match(/\x00/g)?"x"+KindleO_Aaa.o_aaa(a):"t"+a}var A=null,z={},C={};C[Kindle.DB.INSERT_LIST_OPERATION]=r;C[Kindle.DB.UPDATE_RECORD_OPERATION]=t;C[Kindle.DB.UPSERT_RECORD_OPERATION]=o;C[Kindle.DB.DELETE_RECORD_OPERATION]=J;C[Kindle.DB.GET_RECORD_OPERATION]=H;C[Kindle.DB.CREATE_TABLE_OPERATION]=function(a,b,c){var c=
c[0],d="CREATE TABLE IF NOT EXISTS "+b+"(",e="",f,g=!0,h;for(h in c)g?g=!1:d+=", ",d+=h+" ",f=c[h],d+=m(f),f&Kindle.DB.PRIMARY_KEY&&(e+=e?", ":" PRIMARY KEY (",e+=h);e&&(d+=", "+e+")");d+=");";z[b]=c;a.executeSql(d,[])};C[Kindle.DB.ALTER_TABLE_OPERATION]=function(a,b,c){var d=z[b],e,f;e="";for(var g=0;g<c.length;g++)e=c[g],f=d[e]|Kindle.DB.ALLOW_NULL,e="ALTER TABLE "+b+" ADD COLUMN "+e+" ",e+=m(f),e+=";",a.executeSql(e,[])};return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},
openDatabase:function(){var b=new jQuery.Deferred,c=a.defaultSize;f!==void 0&&c>f*1E6&&(c=_maxDbSize*1E6);try{A=openDatabase(a.shortName,"",a.displayName,c)}catch(d){try{A=openDatabase(a.shortName,"",a.displayName,5E6)}catch(g){return b.reject(g)}}var e=parseInt(A.version,10)||A.version;KindleHostDeviceDetector.isiOS_4x()||A.changeVersion(e,a.version);D(a.tables).done(function(){var c=a.versionUpdate,d=[];if(c&&c.length)for(var f=0;f<c.length;f++)c[f].version>e&&d.push({operation:c[f].operation,tableName:c[f].tableName,
params:c[f].params});y(d).then(b.resolve(A),b.reject)}).fail(b.reject);return b.promise()},dropTables:function(){return d(function(a){for(var b in z)a.executeSql("DROP TABLE IF EXISTS "+b+";")},!1)},getTableNames:c,insertRecord:function(a,b){return g(a,[b])},insertList:g,upsertRecord:function(a,c,f){b(a);return d(function(b){o(b,a,[c,f])},!1)},updateRecord:function(a,c,f){b(a);return d(function(b){t(b,a,[c,f])},!1)},getRecord:s,deleteRecord:function(a,c){b(a);return d(function(b){J(b,a,[c])},!1)},
batchTransaction:y,getPieceIds:function(a,b){var c=new jQuery.Deferred;s(a,{asin:b},{id:!0}).then(function(a){var b=[],d;for(d in a)b.push(a[d].id);c.resolve(b)},c.reject);return c.promise()},getOldBookList:function(a){var b=new jQuery.Deferred;s("bookinfo",{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]},cacheState:{operator:Kindle.DB.NOT_EQUAL,values:[Kindle.BookInfo.CachedState.PINNED]}},{asin:!0,openTime:!0}).then(function(a){a.length===0?b.reject():b.resolve(a)},b.reject);return b.promise()},
dbGetBookStatistics:function(a){var b=new jQuery.Deferred,d=[];$.each(c(),function(a,b){z[b]&&z[b].size&&d.push(b)});for(var f={totalSize:0,cacheState:"",cachedSize:0},e,g=[],h=0;h<d.length;h++)g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:d[h],params:[{asin:a},{size:!0}]});g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"bookinfo",params:[{asin:a},{cacheState:!0,cachedSize:!0}]});y(g).then(function(a){for(var c=0;c<d.length;c++){var g=a[c],h=0,s=void 0;for(s in g)h+=g[s].size;
e={count:g.length,size:h};f[d[c]]=e;f.totalSize+=e.size}f.cacheState=a[a.length-1][0].cacheState;f.cachedSize=a[a.length-1][0].cachedSize||0;b.resolve(f)},function(){b.resolve(f)});return b.promise()},dbDeleteBooksData:function(a){var b,d,f,e=[];f=c();for(d=0;d<a.length;++d)for(b=0;b<f.length;++b)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:f[b],params:[{asin:a[d]}]});return y(e)},getSearchIndexData:function(a){var b=$.Deferred();s("searchIndex",{asin:a}).then(function(a){if(!a||
!a.length)b.reject();else{var c={},d={};a.forEach(function(a){c[a.component]=a.data});d.positions=c.positions;d.words=c.words;d.properties=c.properties;b.resolve(d)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),d=[];d.push({asin:a,component:"positions",data:b.positions});d.push({asin:a,component:"words",data:b.words});d.push({asin:a,component:"properties",data:b.properties});g("searchIndex",d).always(function(){c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){var b=
[],c;for(c in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[c].id}]});return y(b)}}}
function KindleStubDBWrapper(a){function f(a){if(!g[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function b(a,b){var c=b[0],d,h,k,m;for(m in c){d={};k=a;h=d;var p;p=k;var o=c[m];f(p);var q=g[p],C=!0,n=void 0,u=void 0;for(u in q.info)if(n=q.info[u],o[u])if(n&Kindle.DB.AUTO_INCREMENT)C=!1;else{switch(typeof o[u]){case "number":C=n&Kindle.DB.NUMBER_TYPE;break;case "string":C=n&Kindle.DB.TEXT_TYPE;break;case "object":C=n&Kindle.DB.OBJECT_TYPE}if(!C)break}else if(n&
Kindle.DB.AUTO_INCREMENT)t[p]++,o[u]=t[p];else if(!(n&Kindle.DB.ALLOW_NULL)||n&Kindle.DB.PRIMARY_KEY)C=!1;p=C?null:Kindle.DB.CONSTRAINT_ERR;C=q=o=void 0;if(p===null){C=g[k].keyList;q=r[k];for(k=0;k<C.length-1;k++)o=C[k],q[o]||(q[o]={}),q=q[h];h.container=q;h.key=C[C.length-1]}h=p;if(h===null)k=c[m][d.key],d.container[k]?h=Kindle.DB.CONSTRAINT_ERR:d.container[k]=c[m];else{h=Kindle.DB.CONSTRAINT_ERR;break}}return h}function d(a,c){var d=new jQuery.Deferred,f=b(a,[c]);f?d.reject(f):d.resolve();return d.promise()}
function c(a,b){f(a);var c=g[a].keyList,d=r[a],h,k,m={};for(h=0;h<c.length;h++)if(k=c[h],b[k])if(h===c.length-1){m.key=b[k];break}else d[b[k]]||(r[b[k]]={}),d=r[b[k]],delete b[k];else break;if(h<c.length-1)throw"unsupported use case for in-memory DB!!";m.container=d;m.selection=b;return m}function h(a,b){var d=b[0],f=null,g=c(a,b[1]);g.container&&g.key&&g.container[g.key]?$.extend(g.container[g.key],d):f=Kindle.DB.CONSTRAINT_ERR;return f}function k(a,c){$.extend(c[0],c[1]);var d=b(a,[[c[0]]]);d===
Kindle.DB.CONSTRAINT_ERR&&(d=h(a,c));return d}function m(a,b,d){var b=b[0],f=g[a],h=r[a],k,m;if(b){if(a=c(a,b),h=a.container)if(a.key)h[a.key]&&d.push(h[a.key]);else for(k in a=a.selection,f=!0,h){for(m in a)if(h[k][m]!==b[m]){f=!1;break}f&&d.push(h[k])}}else if(f.keyList.length!==1)throw"unsupported use case for in-memory DB!!";else for(k in h)d.push(h[k]);return null}function p(a,b){var d=b[0],f,g=r[a],h,k,m;if(d){if(f=c(a,d),g=f.container)if(f.key)delete g[f.key];else for(h in f=f.selection,m=
!0,g){for(k in f)if(g[h][k]!==d[k]){m=!1;break}m&&delete g[h]}}else r[a]={};return null}function q(a){var b=new jQuery.Deferred,c,d=[],f;for(f in a)if(c=a[f],d[f]=[],c=o[c.operation](c.tableName,c.params,d[f]))break;c===null?b.resolve(d):b.reject(c);return b.promise()}var g={},r={},t={},o={};o[Kindle.DB.INSERT_LIST_OPERATION]=b;o[Kindle.DB.UPDATE_RECORD_OPERATION]=h;o[Kindle.DB.UPSERT_RECORD_OPERATION]=k;o[Kindle.DB.DELETE_RECORD_OPERATION]=p;o[Kindle.DB.GET_RECORD_OPERATION]=m;o[Kindle.DB.CREATE_TABLE_OPERATION]=
function(a,b){var c=!0,d=!1,f,h=[],k=0,m=b[0],p;for(p in m)if(f=m[p],f&Kindle.DB.AUTO_INCREMENT||f&Kindle.DB.PRIMARY_KEY)d?c=!1:(d=f&Kindle.DB.AUTO_INCREMENT,h.push(p));if(c){if(h.length===0)h.push("id"),m.id=Kindle.DB.AUTO_INCREMENT,d=!0;g[a]={info:m,keyList:h};(f=r[a])||(r[a]={});if(d){for(var o in f)k=Math.max(k,parseInt(o,10));t[a]=k}}return c?null:Kindle.DB.CONSTRAINT_ERR};(function(){var b;try{b=JSON.parse(KindleLocalStorage.getItem(a))}catch(c){}b&&typeof b==="object"&&(r=b)})();return{persist:function(){var b=
null;try{KindleLocalStorage.setItem(a,JSON.stringify(r))}catch(c){b=Kindle.DB.QUOTA_ERR}return b},createTables:function(a){var b,c,d;b=new jQuery.Deferred;d=[];for(c in a)d.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:c,params:[a[c]]});q(d).then(b.resolve,b.reject);return b.promise()},dropTables:function(){r={};g={};t={};KindleLocalStorage.setItem(a,null);return(new $.Deferred).resolve().promise()},getTableNames:function(){var a=[],b;for(b in g)a.push(b);return a},insertRecord:function(a,
b){return d(a,[b])},insertList:d,upsertRecord:function(a,b,c){var d=new jQuery.Deferred;(a=k(a,[b,c]))?d.reject(a):d.resolve();return d.promise()},updateRecord:function(a,b,c){var d=new jQuery.Deferred;(a=h(a,[b,c]))?d.reject(a):d.resolve();return d.promise()},getRecord:function(a,b){var c=new jQuery.Deferred,d=[],f=m(a,[b],d);f?c.reject(f):c.resolve(d);return c.promise()},deleteRecord:function(a,b){var c=new jQuery.Deferred,d=p(a,[b]);d?c.reject(d):c.resolve();return c.promise()},batchTransaction:q,
deleteJournalEntries:function(a){var b=[],c;for(c in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[c].id}]});return q(b)}}}
var BookChunk=function(){var a=Object.freeze?function(a){return Object.freeze(a)}:function(a){return a},f=["fragment","glyph","skeleton","resource","locationMap"],b={};f.forEach(function(a){b[a]={}});b.resource.huge=!0;var d={types:a(f),properties:a(b),getId:function(a){if(a.fragmentMetadata!==void 0)return a.fragmentMetadata.id;else if(a.skeletonMetadata!==void 0)return a.skeletonMetadata.id;else if(a.glyphFragmentMetadata!==void 0)return a.glyphFragmentMetadata.id;else if(a.metadata!==void 0)return a.metadata.id;
else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};f.forEach(function(a){d[a.toUpperCase()+"_TYPE"]=a});return a(d)}(),RemoteContentCache=function(){return{create:function(a){function f(a){k=a;if(!b||b.state!=="pending")b=$.Deferred();b.resolve(k)}var b=$.Deferred(),d=a.asin,c=a.contentProvider,h=a.contentRemover,k,m={};BookChunk.types.forEach(function(a){m[a]={getChunks:function(b,f,h){c("getChunks",d,a,b).then(f,h)},putChunks:function(b,f,h){var k={};b.forEach(function(a,
b){k[b]=a});c("putChunks",d,a,k).then(f,h)},getCachedIds:function(b,f){c("getChunkIds",d,a).then(b,f)}}});m.queryBookinfo=function(){return c("getBookinfo",d).pipe(function(a){f(a);return a})};m.getBookinfo=function(){return b.promise()};m.putBookinfo=function(a){f(a);return c("putBookinfo",d,a)};m.updateBookinfo=function(a){if(!k)return $.Deferred().reject("bad state");$.extend(k,a);return c("updateBookinfo",d,a)};m.getAnnotations=function(){return c("getAnnotations",d)};m.putAnnotations=function(a){return c("putAnnotations",
d,a)};m.getPageNumbers=function(){return c("getPageNumbers",d)};m.putPageNumbers=function(a){return c("putPageNumbers",d,a)};m.computeQuota=function(){return $.Deferred().resolve(0)};m.getBookStatistics=function(){return $.Deferred().reject()};m.checkCache=function(){return!0};m.deleteOldestBook=function(a,b){b()};m.deleteBooksData=function(){k=void 0;b.state()!=="pending"&&(b=$.Deferred());return h({asin:d})};m.downloadSearchIndex=function(a){return c("getSearchIndexReader",d,a)};m.initMetadata=
function(a){return c("initMetadata",d,a)};return m}}}(),ContentMigration=function(){function a(a){function b(d){var f="get"+(d.substr(0,1).toUpperCase()+d.substr(1))+"Ids";return a.source[f]().pipe(function(b){function f(){var m=b.splice(0,100);if(m.length===0)h.then(k.resolve,k.reject);else{var p="get"+(d.substr(0,1).toUpperCase()+d.substr(1))+"s",m=a.source[p](m);$.when(m,h).then(function(b){var k={};b.forEach(function(a,b){k[b]=a});h=a.target("putChunksNonT",a.asin,d,k);setTimeout(f,100)},k.reject)}}
var h=$.Deferred().resolve(),k=$.Deferred();f();return k.promise()})}function d(){var a=BookChunk.types[p++];a?b(a).then(d,f.reject):f.resolve()}var f=$.Deferred(),p=0,q=a.timer.createSubTimer("chunks");d();f.done(function(){q.endTimer()});return f.promise()}function f(a){var b=$.Deferred(),d=a.timer.createSubTimer("annotations");a.source.getAnnotations().then(function(d){a.target("putAnnotations",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function b(a){var b=
$.Deferred(),d=a.timer.createSubTimer("pageNumbers");a.source.getPageNumbers().then(function(d){a.target("putPageNumbers",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function d(a){var b=$.Deferred(),d=a.timer.createSubTimer("bookinfo");a.source.getBookInfo().then(function(d){a.target("putBookinfo",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,
[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,h){return{moveBook:function(k){var m=$.Deferred(),p=c.getBookDb();if(!k)return m.reject("Need ASIN as param").promise();var q={timer:KindleMetricsProfiler("Migrate "+k),asin:k,target:h.contentProvider,source:p.BookInfoDB(k)},k=$.when(a(q),f(q),b(q),d(q));k.then(function(){q.timer.endTimer();q.timer.log()});k.then(m.resolve,m.reject);return m.promise()},notifyMigrationStatus:function(a){var b=$.Deferred();if(!a||!a.status)return b.reject("Need param.status as param").promise();
a.status==="done"?c.getBookDb().dropTables().then(b.resolve,b.reject):b.reject("this status is not handled");return b.promise()}}})}}}();function AssertionError(a){Error.call(this,a)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function a(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}var f;return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},useNativeSelection:a,useCSSRegions:function(){return a()},
useLocaleCompare:function(){if(f===void 0){try{"a".localeCompare("b","i")}catch(a){return f=a.name==="RangeError"}f=!1}return f},showFirstRunDialog:function(){return!KindleHostDeviceDetector.isMSEdge()},hasPageResizeIssues:function(){return KindleHostDeviceDetector.isiOS_9x()?!0:!1},hasSplitView:function(){return KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion()>=9}}}(),KindleHostDeviceDetector=function(){function a(){return navigator.platform.indexOf("iPad")!==-1}function f(){return navigator.platform.indexOf("iPhone")!==
-1||navigator.platform.indexOf("iPod")!==-1}function b(){return a()||f()||q()}function d(){var a=-1;b()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return(a()||f())&&parseInt(d(),10)===7}function h(){return(a()||f())&&parseInt(d(),10)>=8}function k(){return(a()||f())&&parseInt(d(),10)>=9}function m(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function p(a){var b=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);
return!b?!1:!a?!0:Number(b[1])>=Number(a)}function q(){return navigator.userAgent.indexOf("Cloud9")!==-1}function g(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function r(){return g()&&t()}function t(){return!!/arm/i.test(navigator.cpuClass)}function o(){return m()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function w(){return navigator.userAgent.indexOf("MSIE")!==-1||navigator.userAgent.indexOf("Trident")!==-1}function s(){return navigator.userAgent.indexOf("Chrome")!==
-1&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Edge")!==-1}function x(){return"standalone"in navigator&&navigator.standalone}function H(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function J(){return window.navigator.msMaxTouchPoints>=1}return{isiOS:b,isiPad:a,isiPhone:f,isiOS_4x:function(){return(a()||f())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){return(a()||f())&&parseInt(d(),10)>=5},isiOS_7x:c,isiOS_8x:h,
isiOS_9x:k,hasiOSInnerHeightBug:function(){return!k()&&(c()||h())},hasCanvasSizeLimitProblem:function(){return b()},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:m,hasHangingDbPrompt:function(){if(!m())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:p,isMetro:g,isMetroArm:r,isMetroSnappedView:function(){return g()&&window.outerWidth===320},isIE:w,isIE10:function(){return w()&&navigator.userAgent.indexOf("Trident/6.0")!==
-1},isIE11:function(){return w()&&(navigator.userAgent.indexOf("Trident/7.0")!==-1||navigator.userAgent.indexOf("Trident/8.0")!==-1)},isMSEdge:s,isArm:t,isCloud9:q,isTablet:function(){return a()||g()},isOnline:o,isPageVisibilityApiSupported:function(){var a;typeof document.hidden!=="undefined"?a="hidden":typeof document.msHidden!=="undefined"?a="msHidden":typeof document.webkitHidden!=="undefined"&&(a="webkitHidden");return a!==void 0&&typeof document.addEventListener!=="undefined"},getPageVisibilityApiTerms:function(){var a,
b;typeof document.hidden!=="undefined"?(a="hidden",b="visibilitychange"):typeof document.msHidden!=="undefined"?(a="msHidden",b="msvisibilitychange"):typeof document.webkitHidden!=="undefined"&&(a="webkitHidden",b="webkitvisibilitychange");return{hidden:a,visibilityChange:b}},isNetworkAvailable:function(){if(!o())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!o())return!1;
var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome&&!s()},isiOSAppMode:x,isChromeApp:H,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return x()||H()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!=="undefined"},isLocalStorageEnabled:function(){return KindleLocalStorage.isLocalStorageEnabled()},
hasArrayLikeApply:function(){return!b()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:J,isTouchDevice:function(){return b()||J()},getDevicePlatform:function(){return a()?"iPad":f()?"iPhone":q()?"otter":r()?"metroArm":g()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return a()&&KindleHostPadDetector.isPad1(x())||
r()},hasMissingImgOnLoadProblem:function(){return p()||x()||m()},hasImageRenderingProblem:function(){return p()||x()},getDeviceType:function(){return g()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return g()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:d,getOSMinorVersion:function(){var a=-1;b()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),
KindleHostPadDetector=function(){return{isPad1:function(a){if(KindleLocalStorage.getItem("definitelyNotPad1"))return!1;var f=0,b=1E3,d=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>f?f=c:c<b&&(b=c),d+=c;f=d/3;if(f>=200&&a)return!0;if(f>=100&&!a)return!0;KindleLocalStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function a(a,b){for(var d in b)if(b.hasOwnProperty(d)&&typeof a[d]!==typeof b[d])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},removeBook:function(){}},
IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:a,assertImplements:function(f,b){a(f,b)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function a(a){var b=[],c;for(c in a){var d=a[c].entry;d.guid=d.guid||d.refEmId;delete d.refEmId;d&&b.push(d)}return b}function f(a){var b=[],d;for(d in a)b.push({entry:a[d]});return h.getAppDb().getTable(c).insertList(b)}function b(b){function c(){var t,o=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset();f<b.length?(r=Math.min(f+100,b.length),t=Array.prototype.slice.call(b,f,r),
f=r,k.updateAnnotations(a(t),o).then(function(){h.getAppDb().deleteJournalEntries(t).then(c,d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,f=0,r;c();return d.promise()}function d(){var a=new jQuery.Deferred;h.getAppDb().getTable(c).getRecord().then(function(c){c.length>0?b(c).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var c="journal",h=null,k=null;return{initialize:function(){var a=new jQuery.Deferred,b=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,
KindleModuleManager.DB_CLIENT]).then(function(c){k=c[KindleModuleManager.SERVICE_CLIENT];h=c[KindleModuleManager.DB_CLIENT];a.resolve(b)},a.reject);return a.promise()},saveToJournal:function(a){var b=new jQuery.Deferred;f(a).then(function(){d().then(b.resolve,b.resolve)},b.reject);return b.promise()},uploadJournal:d}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")},
setDeviceToken:function(a){KindleLocalStorage.setItem("kindleDeviceToken",a)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.removeItem("kindleDeviceToken")}}}(),KindleMetricsProfiler=function(a){function f(a){for(var b=0,f=0;f<a.length;f+=1)b+=a[f].end-a[f].start;return b}var b={};b.name=a;b.counters=null;b.subTimers=null;b.runs=[{start:(new Date).getTime(),end:null}];b.endTimer=function(){var a=this.runs[this.runs.length-1];if(a.end===null)a.end=(new Date).getTime()};b.addCount=function(a,
b){if(this.counters===null)this.counters={};this.counters[a]===void 0?this.counters[a]=b:this.counters[a]+=b};b.createSubTimer=function(a){if(this.subTimers===null)this.subTimers={};this.subTimers[a]===void 0?this.subTimers[a]=KindleMetricsProfiler(a):this.subTimers[a].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[a]};b.log=function(){this.logAsPercentageOfTime("",f(this.runs))};b.logAsPercentageOfTime=function(a,b){var h=a+":"+this.name,k,m=f(this.runs);KindleDebug.log(h+
":Time: "+m+"ms - ("+(b?m/b*100:100).toFixed(2)+"%)");for(k in this.counters)KindleDebug.log(h+":"+k+" : "+this.counters[k]);for(k in this.subTimers)this.subTimers[k].logAsPercentageOfTime(h,b)};return b};
function KindleModuleManagerFactory(){function a(a,b){if(o[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;o[a]=b;w[a].resolve(b)}function f(a){if(o.hasOwnProperty(a))throw"Duplicate registration of module "+a;o[a]=void 0}function b(b,c){w[b]||(w[b]=new jQuery.Deferred);a(b,c)}function d(b,c){f(b);w[b]||(w[b]=new jQuery.Deferred);c(w[b]);w[b].done(function(c){a(b,c)})}function c(a,b){d(a,function(a){b.done(a.resolve).fail(a.reject)})}function h(a){w[a]||
(w[a]=new jQuery.Deferred);return w[a].promise()}function k(a){if(!o[a])throw"Trying to get uninitialized module "+a;return o[a]}function m(a){return o.hasOwnProperty(a)}function p(a,b){o[a]=b}function q(a){var b=o[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function g(a){for(var b={},c=0;c<a.length;c++)b[name]=o[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function r(){o={}}var t={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network",LINK_URLS:"linkUrls"},o={},w={};return{CONSTANTS:t.CONSTANTS,DB_CLIENT:t.DB_CLIENT,RESOURCE_BUNDLE:t.RESOURCE_BUNDLE,METRICS_MANAGER:t.METRICS_MANAGER,SERVICE_CLIENT:t.SERVICE_CLIENT,APP_REGISTRATION:t.APP_REGISTRATION,
JOURNAL_MANAGER:t.JOURNAL_MANAGER,BOOK_METADATA:t.BOOK_METADATA,BOOK_FRAGMAP:t.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:t.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:t.CONTENT_MIGRATION,NETWORK:t.NETWORK,LINK_URLS:t.LINK_URLS,ERROR_CODE_CANCEL:"canceled",registerModule:b,registerModuleList:function(a){for(var c in a)b(c,a[c])},registerModuleWithInitializer:d,registerModuleWithDeferred:c,detachModule:function(a){var b=o[a],c=w[a];c&&!c.isResolved()&&c.reject("canceled");delete o[a];delete w[a];return b},getModule:h,
getModuleList:function(a){var b=new jQuery.Deferred,c,d=[];for(c=0;c<a.length;c++)d.push(h(a[c]));$.when.apply($,d).done(function(){var c,d={};for(c=0;c<a.length;c++)d[a[c]]=arguments[c];b.resolve(d)}).fail(b.reject);return b.promise()},getModuleSync:k,isModuleInitialized:function(a){return o[a]!==void 0},isModuleRegistered:m,switchToTestMode:function(){this.registerModuleTest=p;this.getModule=q;this.getModuleSync=k;this.getModuleList=g;this.clear=r;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},
define:function(a,b,d){if(!m(a)){var f=[],g=$.Deferred();c(a,g);b&&b.length&&b.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:h(a))});$.when.apply($,f).then(function(){var a;typeof d==="function"?(a=$.makeArray(arguments),a=d.apply(d,a)):a=d;a&&$.isFunction(a.promise)?a.then(g.resolve,function(){g.reject()}):g.resolve(a)},function(){g.reject()})}},require:function(a,b){$.isArray(a)||(a=[a]);var c,d,f=[];a.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:h(a))});b||(d=$.Deferred(),
c=d.promise());$.when.apply($,f).then(function(){var a=$.makeArray(arguments);b?b.apply(b,a):d.resolve.apply(d,a)},function(){d&&d.reject()});return c}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{uploadFeedback:function(a){if(!a)return(new $.Deferred.reject).promise();var f=KindleLibrarySetting.getSettings(),f={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,AppCached:!!KindleLocalStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),
ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:f.sortParam,LibraryView:f.viewState,TLD:Kindle.URL.getAmazonDomain()||"unknown"};return function(a){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(d){try{var c=d.getAppDb(),f=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),k=c.getAllBooks();a.info.OfflineStorageEnabled=!!d.bookDbEnabled();
return $.when(f,k)}catch(m){return $.Deferred.reject()}}).pipe(function(d,c){$.extend(a.info,{TotalBookCount:c.length,TotalBookDownloaded:d.length});return a.eid?a.eid:KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT).getEID()}).pipe(function(d){a.eid=d;return a},function(){return $.Deferred().resolve(a)})}({version:KindleVersion.getVersionString(),message:a.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:f}).pipe(function(a){a={url:"/remote/feedback",type:"POST",processData:!1,
contentType:"application/json",data:JSON.stringify(a)};return $.ajax(a)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(a){return ResourceBundle.getLocalizedString(a)})}}}(),KindleUserAgentMetricsInfo=function(){function a(){function a(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);if(b)return b[1]}var c;if(!(c=function(){var a;if(["ipad","iphone"].indexOf(b)!==-1&&(b="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&
a.length>=2))return a[1]}())){var d;KindleHostDeviceDetector.isIE()&&(d=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");c=d||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return c}var f,b,d,c,h,k={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4,edge:16};return{browserWithVersionString:function(){if(!f){b=GoogleUserAgent.browserName.toLowerCase();d=a();a:{if(d){var m=/^0*([0-9]+)/.exec(d);if(m&&m.length>=2){c=parseInt(m[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+
d)}c=void 0}h="undefined"===typeof c?"other":k[b]?[b,c].join("@"):"other";f=!0}return h}}}(),KindleVersion=function(){var a="011208999";window.location.hostname==="k4w-dev.aka.amazon.com"&&(a="999999998");if(a.length!==9)throw{name:"BadVersion",message:"bad version number. got: "+a};var f=null,b=null;return{getMetricsVersionString:function(){b||(b=parseInt(a.slice(0,2),10),b+=".",b+=parseInt(a.slice(2,4),10),b+=".",b+=parseInt(a.slice(4,6),10));return b},getVersionString:function(){f||(f=parseInt(a.slice(0,
2),10),f+=".",f+=parseInt(a.slice(2,4),10),f+=".",f+=parseInt(a.slice(4,6),10),f+=".",f+=parseInt(a.slice(6),10));return f},getVersionNumber:function(){return Number(a)},parseVersionString:function(a){return a&&(a=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(a))?Number(a[1])*1E7+Number(a[2])*1E5+Number(a[3])*1E3+Number(a[4]):NaN}}}(),LinkUrls=function(){function a(){d||(Kindle.URL.isPreProd()?(b=(b=Kindle.URL.getPreProdCountryCode())?b:"us",d=Kindle.CountryToDomainMap[b]):(d=Kindle.URL.getAmazonDomain(),
b=Kindle.DomainToCountryMap[d]))}function f(a){return $.Deferred().resolve(function(){var b;b=c+Kindle.CountryToDomainMap.us+h;b+="?"+m.DeviceType+"="+Kindle.DeviceType.KCR+"&"+m.Eid+"="+(q||"")+"&"+m.Method+"="+a;return b}())}var b,d,c="https://www.",h="/gp/kindle/kcp/links",k={Help:{NodeId:"200701430"},OfflineReading:{NodeId:"201255020"},IncreaseOfflineStorage:{NodeId:"201265520"},TroubleShooting:{NodeId:"200732370"},License:{NodeId:"200701450",RefTag:"kcr_legalnotices_menu"},KCPLanding:{DocId:{us:"1000493771",
uk:"1000425503",de:"1000482783",fr:"1000538763",it:"1000576423",es:"1000576363",jp:"3077089376",au:"3077705566",cn:"98968","in":"1000659093",ca:"1000817631",br:"1000828031",mx:"1001216041"},iTunesURL:"https://itunes.apple.com/",iTunesEndPoint:"/app/apple-store/id302584613?mt=8",DesktopEndpoint:"/gp/feature.html",DesktopQueryParam:"?ie=UTF8&docId="}},m={DeviceType:"deviceType",Eid:"eid",Method:"method",Asin:"a"},p={Help:"Help",Legal:"License",Terms:"TermsCond",Store:"StoreFront",Privacy:"Privacy",
DetailPage:"DetailPage"},q;return{getStoreUrl:function(b){if(q&&!b.kcrFree)return f(p.Store).pipe(function(a){b.tag&&(a+="&tag="+b.tag);b.refTag&&(a+="&ref_="+b.refTag);return a});else{a();var h=c+d+"?ref_="+b.refTag;b.tag&&(h+="&tag="+b.tag+"&at="+b.tag);return $.Deferred().resolve(h)}},getPrivacyUrl:function(){a();return c+d+"/privacy"},getTermsOfUseUrl:function(){return"http://www.kindle.com/support/terms"},getLegalUrl:function(){a();return c+d+"/gp/help/customer/display.html?nodeId="+k.License.NodeId+
"ref="+k.License.RefTag},getHelpUrl:function(){a();return c+d+"/gp/help/customer/display.html?nodeId="+k.Help.NodeId},getOfflineReadingUrl:function(){a();return c+d+"/gp/help/customer/display.html?nodeId="+k.OfflineReading.NodeId},getIncreaseOfflineStorageUrl:function(){a();return c+d+"/gp/help/customer/display.html?nodeId="+k.IncreaseOfflineStorage.NodeId},getTroubleShootingUrl:function(){a();return c+d+"/gp/help/customer/display.html?nodeId="+k.TroubleShooting.NodeId},getDetailPage:function(b){if(q&&
!b.kcrFree)return f(p.DetailPage).pipe(function(a){a+="&"+m.Asin+"="+b.asin;b.tag&&(a+="&tag="+b.tag);b.refTag&&(a+="&ref_="+b.refTag);return a});else{a();var h=c+d+"/dp/"+b.asin+("?ref_="+(b.refTag||Kindle.RefTag.Values.StoreSample));b.tag&&(h+="&tag="+b.tag+"&at="+b.tag);return $.Deferred().resolve(h)}},getKCPLandingPageLink:function(f){(!d||!b)&&a();var h;KindleHostDeviceDetector.isiPad()?h=k.KCPLanding.iTunesURL+b+k.KCPLanding.iTunesEndPoint:(h=c+d+k.KCPLanding.DesktopEndpoint,h=f?h+"/ref="+f:
h,h+=k.KCPLanding.DesktopQueryParam+k.KCPLanding.DocId[b]);return h},getDownloadLink:function(f){(!d||!b)&&a();var h=c+d+"/gp/kindle/kcpApp.html";return f?h+"/ref="+f:h},getAmazonDomainURL:function(){(!d||!b)&&a();return c+d},getRTEServiceURL:function(){(!d||!b)&&a();if(Kindle.URL.isPreProd()){var c="https://kindlestore-preprod";if(b==="it"||b==="es"||b==="in")c+="-eux";return c+"."+d+"/gp/digital/fiona/ajax/send-email-or-sms.html"}return this.getAmazonDomainURL()+"/gp/digital/fiona/ajax/send-email-or-sms.html"},
getNotebookURL:function(a,b){var c=Kindle.URL.getHostURL()+"/notebook",d=[];a&&d.push("asin="+a);b&&d.push("ref_="+b);return c=d?c+"?"+d.join("&"):c},initializeEid:function(a){q=a}}}(),KindleChromeInstaller=function(){function a(){function a(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(a,250)},function(a){KindleDebug.error(a)})}function f(){return window.chrome&&Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}
return{install:function(){f()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&f()){var b=document.createElement("button");b.id="inlineInstallProxy";b.style.display="none";$(b).click(a);$("body").append(b)}}}}(),KindleFirefoxInstaller=function(){function a(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}function f(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();
var b=$.Deferred(),d=navigator.mozApps.getInstalled();d.onsuccess=function(){var c=!1,f=a();d.result.forEach(function(a){a.manifestURL===f&&(c=!0)});b.resolve(c)};d.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);b.reject()};return b.promise()}return{install:function(){var b=$.Deferred();f().done(function(d){d?b.reject():(d=navigator.mozApps.install(a()),d.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");b.resolve()},d.onerror=
function(){KindleDebug.error("Firefox App failed to install.");b.reject()})}).fail(b.reject);return b.promise()}}}();
EmbeddedReaderAPI={setLoginParameters:function(){},setFocusToReader:function(){},showAppbar:function(){},hideAppbar:function(){},toggleAppbar:function(){},sendMetrics:function(){},sendMetricsNow:function(){},deregister:function(){},clearDatabases:function(){},clearLocalStorage:function(){},openBook:function(){},goTo:function(){},downloadBook:function(){},requestDownloadedBookList:function(){},cancelBookDownload:function(){},removeBook:function(){},removeBookOwnership:function(){},getSearchContext:function(){},
requestOemAssociateId:function(){},getTodoItems:function(){},removeTodoItems:function(){},uploadSnapshot:function(){},getSearchIndex:function(){},getDownloadedBookInfo:function(){},requestDeviceName:function(){},getSelectedText:function(){},hideContextMenu:function(){},setStoreCookies:function(){},setServiceHost:function(){},uploadJournal:function(){},getTOSParams:function(){},moveAsinToHost:function(){},notifyMigrationStatus:function(){},updateAppCache:function(){},convertPositions:function(){},
updateAnnotations:function(){}};
ReaderHostAPI={onReaderLoaded:function(){},onAppCacheStatus:function(){},onAppCacheUpdateReady:function(){},onBookOpenStatus:function(){},onBookClose:function(){},onOpenStore:function(){},onServiceAuthState:function(){},pinBookToStart:function(){},onBookDownloadComplete:function(){},onBookDownloadFailed:function(){},onBookDownloadProgress:function(){},onDeregister:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},showWebPage:function(){},getRequestSigningHeaders:$.rpc.fn(),
contentProvider:$.rpc.fn({timeout:9E4}),deleteBookContent:$.rpc.fn(),searchContent:function(){},showAnnotations:function(){}};function ReaderHostInterfaceFactory(a,f){KindleInterfaces.assertImplements(a,EmbeddedReaderAPI);return $.rpc({name:"KCR",iRemote:ReaderHostAPI,local:a,channelId:"reader",target:window.parent,remoteDomain:f})};
